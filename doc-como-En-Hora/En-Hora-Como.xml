<?xml version="1.0" encoding="iso-8859-1" ?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook V4.1.2//EN"
"http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd">

<article>

<articleinfo>

<title>En Hora mini-COMO</title>

<author>
<firstname>Ron Bean, <ulink
url="mailto:rbean@execpc.com"
>rbean@execp.com</ulink
>

Traducido por Rodolfo Pilas, <ulink
url="mailto:rodolfo@linux.org.uy"
>rodolfo@linux.org.uy</ulink
></firstname>
</author>

<abstract>

<para>
Cómo configurar y mantener el reloj de su computadora en hora.
</para>

</abstract>

</articleinfo>

<sect1>
<title>Introducción</title>

<para>
Los chips de reloj-de-tiempo-real (<emphasis>real-time-clock</emphasis>) que son usados
en las placas madres de los PC (y también en las costosas estaciones de
trabajo) son notoriamente inexactos. Linux dispone de una forma simple de
corregir esto por software, haciendo que el reloj sea potencialmente
<emphasis remap="bf">muy</emphasis> exacto sin necesidad de una fuente externa de confirmación
del tiempo.  Pero muchas personas no reparan en esto, por varias razones: 
</para>

<para>

<orderedlist>
<listitem>

<para>
No es mencionado en la mayoría de la documentación sobre "Cómo
configurar Linux", y es bastante difícil de configurar automáticamente en
el momento de la instalación (sin embargo, sería posible en teoría, si se
dispusiera de un módem).

</para>
</listitem>
<listitem>

<para>
Si revisa "<literal remap="tt">man clock</literal>" verá <literal remap="tt">clock(3)</literal>, que no es lo que
se quiere. (pruebe "<literal remap="tt">man 8 clock</literal>"). 

</para>
</listitem>
<listitem>

<para>
La mayoría de las personas no prestan mucha atención a la hora. 

</para>
</listitem>
<listitem>

<para>
Aquellos pocos que sí lo hacen, buscan usar el paquete <literal remap="tt">xntpd</literal> de
<literal remap="tt"><ulink
url="http://louie.udel.edu"
>http://louie.udel.edu</ulink
></literal> para sincronizar con una fuente externa
el reloj, como un servidor de hora de red o un radio-reloj. 
</para>
</listitem>

</orderedlist>

</para>

<para>
Este mini-COMO describe un acercamiento sencillo al tema. Si Usted está
completamente interesado en esto, le recomiendo encarecidamente que
invierta un tiempo en <literal remap="tt"><ulink
url="http://www.eecis.udel.edu/&#732;ntp/"
>http://www.eecis.udel.edu/&#732;ntp/</ulink
></literal> donde encontrará todo
lo relativo a este interesante asunto, incluyendo información completa
sobre <literal remap="tt">xntpd</literal> y enlaces para NIST y USNO (hay más comentarios sobre
<literal remap="tt">xntpd</literal> al finalizar). 
</para>

<para>
Nota:
</para>

<para>
<quote
>Si usa más de un sistema operativo en su máquina, debe dejar que
solamente uno de ellos corrija el reloj del CMOS, para evitar que uno se
confunda con otro. Si regularmente corre Linux y Windows en la misma
máquina, puede echar una mirada a algún programa de reloj shareware que
este disponible para Windows (siga los enlaces del url indicado arriba). </quote
>
</para>

</sect1>

<sect1>
<title>Uso del programa <literal remap="tt">clock</literal></title>

<para>
Todo lo que necesita saber está en la página man de <literal remap="tt">clock(8)</literal>, y este
mini-COMO lo guiará a través del proceso.
</para>

<para>
Nota:
</para>

<para>
<quote
>Debe ser root para ejecutar "<literal remap="tt">clock</literal>", o cualquier otro programa
que afecte la hora del sistema o el reloj del CMOS.</quote
>
</para>

<sect2>
<title>Revisión de su sistema</title>

<para>
Revise sus archivos de inicio del sistema buscando una línea de comando
semejante a "<literal remap="tt">clock -a</literal>" o "<literal remap="tt">clock -ua</literal>".  Dependiendo de la
distribución que esté utilizando, puede estar en <literal remap="tt">/etc/rc.local</literal> o
en <literal remap="tt">/etc/rc.d/rc.sysinit</literal>, <literal remap="tt">/etc/rc.d/init.d</literal> o algún otro
lugar similar.
</para>

<para>
Si aparece como "<literal remap="tt">clock -s</literal>" o "<literal remap="tt">clock -us</literal>", cambie la
"<literal remap="tt">s</literal>" por una "<literal remap="tt">a</literal>", y compruebe si tiene el archivo
<literal remap="tt">/etc/adjtime</literal>, que contiene una sola línea semejante a esta:
</para>

<para>

<screen>
0.000000 842214901 0.000000
</screen>

</para>

<para>
Estos números son el factor de corrección (en segundos por día), el
momento que reloj fue corregido por última vez (en segundos desde Enero 1,
1970), y el momento (segundo) en que fue corregido por última vez.  Si no
dispone de este archivo, entre en el sistema como root y créelo, con una
única línea que como esta (todo en cero):
</para>

<para>

<screen>
0.0 0 0.0
</screen>

</para>

<para>
Ejecute "<literal remap="tt">clock -a</literal>" o "<literal remap="tt">clock -ua</literal>"  manualmente desde la
línea de comando para actualizar el segundo número (use la "<literal remap="tt">u</literal>" si su
reloj esta marcando la hora Universal en lugar el tiempo local).
</para>

</sect2>

<sect2>
<title>Cálculo de las variaciones de su reloj</title>

<para>
Primero, necesita saber qué hora es <literal remap="tt">:-)</literal>.  Su hora del día puede estar
o no ajustada.  Mi método favorito es llamar al servicio WWV al (303)
499-7111 (es una llamada por voz).  Si dispone de acceso a un servidor de
horario en la red, puede utilizar el programa <literal remap="tt">ntpdate</literal> del paquete
<literal remap="tt">xntpd</literal> (utilice el parámetro <literal remap="tt">-b</literal> para permitir que el kernel
actualice el reloj del CMOS).  De lo contrario use <literal remap="tt">date -s
hh:mm:ss</literal> para poner en hora el reloj del kernel a mano, y entonces
<literal remap="tt">clock -w</literal> para el reloj del CMOS, tomando la hora del reloj del
kernel.  Deberá recordar cuándo puso en hora el reloj por última vez, lo
mejor es escribir la fecha en algún lugar donde no la pierda. Si utilizó
<literal remap="tt">ntpdate</literal>, con <literal remap="tt">date +%s</literal>" puede registrar el número de
segundos desde Enero 1, 1970.
</para>

<para>
Entonces, vuelva algunos días o semanas después para ver cuánto se ha
desviado su reloj.  Si puso la hora a mano, le recomiendo espere al menos
dos semanas para poder calcular la desviación lo más aproximada a .1
seg/día.  Después de algunos meses le será posible determinarla con
exactitud cercana a .01 seg/día (algunas personas prefieren más exactitud
aún, pero yo ya soy conservador a estas alturas).  Si ha utilizado
<literal remap="tt">ntpdate</literal> no es necesario que espere tanto tiempo, pero siempre podrá
hacer un mejor ajuste cuanto más tiempo pase. 
</para>

<para>
Puede ejecutar con cron el comando "<literal remap="tt">clock -a</literal>" a intervalos
regulares para mantener la hora del sistema ajustada con el horario
(corregido) de la CMOS. Este comando puede ejecutarse también desde algún
archivo de inicio en el momento del arranque, si Vd hace esto (como lo
hacemos casi todos nosotros) será suficiente para sus propósitos. 
</para>

<para>
Tenga en cuenta que algunos programas pueden quejarse si el sistema salta
más de un segundo a la vez, o si va para atrás. Si tiene este problema,
puede utilizar <literal remap="tt">xntpd</literal> o <literal remap="tt">ntpdate</literal> para corregir el tiempo más
gradualmente. 
</para>

</sect2>

<sect2>
<title>Ejemplo</title>

<sect3>
<title>Estableciendo la hora</title>

<para>
Entre como root. Llame al (303) 499-711 (voz), escuche el anuncio de la
hora y escriba:
</para>

<para>

<screen>
date -s hh:mm:ss
</screen>

</para>

<para>
pero no presione ENTER hasta no escuchar el beep (puede utilizar
<literal remap="tt">ntpdate</literal> aquí en lugar de <literal remap="tt">date</literal>, y evitar la llamada por
teléfono.  Esto establece la hora del núcleo (<emphasis>kernel time</emphasis>). 
Luego escriba:
</para>

<para>

<screen>
clock -w
</screen>

</para>

<para>
Esto pone en hora la CMOS a partir de la hora del núcleo. Y ahora escriba: 
</para>

<para>

<screen>
date +%j
</screen>

</para>

<para>
(o <literal remap="tt">date +%s</literal> si ha usado <literal remap="tt">ntpdate</literal> en lugar de
<literal remap="tt">date</literal> arriba) y escriba el resultado, para la próxima vez. 
</para>

</sect3>

<sect3>
<title>Restablecimiento de la hora y cálculo de la desviación.</title>

<para>
Busque la fecha en que ajustó la hora la vez anterior. Entre como root y
escriba: 
</para>

<para>

<screen>
clock -a
</screen>

</para>

<para>
Esto hace que el núcleo tome la hora de la CMOS. Llame al (303) 499-7111
(voz) y escuche el anuncio. Entonces escriba: 
</para>

<para>

<screen>
date
</screen>

</para>

<para>
Presionando ENTER en el momento que escuche el beep, pero mientras está
esperando, apunte la hora que escucha y no cuelgue aún.  Lo que escucha es
la hora que debería tener su máquina cuando se encuentra exacta en el
minuto. Escriba:
</para>

<para>

<screen>
date hh:mm:00
</screen>

</para>

<para>
usando el minuto <emphasis remap="bf">siguiente</emphasis> al cual acaba de escuchar y presionando
ENTER en el momento en que escuche el beep nuevamente (ahora puede
colgar).  Para <literal remap="tt">hh</literal> utilice su hora local.  Esto coloca la hora del
núcleo (<emphasis>kernel time</emphasis>). Teclee:
</para>

<para>

<screen>
clock -w
</screen>

</para>

<para>
el cual establecerá la nueva hora (correcta) en el reloj del CMOS.
Escriba: 
</para>

<para>

<screen>
date +%j
</screen>

</para>

<para>
(o <literal remap="tt">date +%s</literal> si es lo que ha utilizado anteriormente) 
</para>

<para>
Ahora dispone de tres números (dos fechas y un intervalo de tiempo) que le
permitirán calcular el desvío horario.
</para>

</sect3>

<sect3>
<title>Cálculo del factor de corrección</title>

<para>
¿Cuándo ejecutó <literal remap="tt">date</literal> en el minuto, su máquina iba atrasada o
adelantada?  Si iba adelantada, deberá descontar algunos segundos, aunque
le resulte un número negativo.  Si estaba retrasada, deberá agregar
algunos segundos, aunque resulte un número positivo. 
</para>

<para>
Ahora reste ambas fechas.  Si usó "<literal remap="tt">date +%j</literal>" , el número
representando el día del año (1-365 o 1-366 en año bisiesto). Si Usted ha
pasado el 1 de Enero entre la primera y segunda fecha entonces deberá
agregar 365 (o 366) al segundo número.  Si usó <literal remap="tt">date +%s</literal> su
número está en segundos y deberá dividirlo por 86400 para obtener días. 
</para>

<para>
Si ya tiene un factor de corrección en <literal remap="tt">/etc/adjtime</literal>, deberá tomar
en consideración el número de segundos que ha corregido. Si ha corregido
adelantando, este número tendrá el signo opuesto al del que ha medido; si
ha corregido atrasando tendrá el mismo signo.  Multiplique el antiguo
factor de corrección por el número de días, y añada el número de segundos
resultante (adición con signos <literal remap="tt">-</literal> si ambos números tienen el mismo
signo: obtendrá un número mayor; si tienen signos opuestos, obtendrá un
número menor). 
</para>

<para>
Divida el número total de segundos por el número de días para tener el
nuevo factor de corrección, y colóquelo en <literal remap="tt">/etc/adjtime</literal> en lugar
del anterior.  Registre la nueva fecha (en segundos o días) para la
próxima vez. 
</para>

<para>
He aquí mi <literal remap="tt">/etc/adjtime</literal>:
</para>

<para>

<screen>
-9.600000 845082716 -0.250655
</screen>

</para>

<para>
(¡Nótese que 9.6 segundos por día es aproximadamente cinco minutos
al mes!)
</para>

</sect3>

</sect2>

</sect1>

<sect1>
<title>Algunas consideraciones sobre <literal remap="tt">xntpd</literal></title>

<para>
Su sistema actualmente dispone de dos relojes - el alimentado por la
batería reloj de tiempo real (<emphasis>real time clock</emphasis>) que mantiene la
hora cuando el sistema está apagado (también conocido como el reloj de la
CMOS (<emphasis>CMOS clock</emphasis>, <emphasis>Hardware clock</emphasis> o <emphasis>RTC</emphasis>) y la
hora del núcleo (<emphasis>kernel time</emphasis> o también conocido como <emphasis>software
clock</emphasis> o <emphasis>system clock</emphasis>)  que está basado en interrupciones de
tiempo y que es inicializado con el reloj del CMOS en el momento del
arranque. Ambos relojes pueden diferir en el tiempo que marcan, de hecho
gradualmente difieren uno de otro a medida que pasa el tiempo, y también
difieren de la "hora real". 
</para>

<para>
Todas las referencias al "reloj" (<emphasis>the clock</emphasis>) en la documentación
de <literal remap="tt">xntpd</literal> se refieren a la hora del núcleo. Cuando ejecute <literal remap="tt">xntpd</literal>
o <literal remap="tt">timed</literal> (o cualquier otro programa que ajusta la llamada del sistema
de adjtimex), el núcleo de linux asume que la hora del núcleo es más
precisa que el reloj del CMOS, y ajusta el reloj del CMOS cada 11 minutos
(hasta que apague el sistema).  
</para>

<para>
Esto significa que <literal remap="tt">clock</literal> no sabrá más cuándo el reloj del CMOS
fue ajustado por última vez, y no podrá utilizar el factor de corrección
en <literal remap="tt">/etc/adjtime</literal>.  Puede usar <literal remap="tt">ntpdate</literal> en su archivo de
inicialización para poner en hora el reloj desde un servidor de tiempo en
red, antes de iniciar <literal remap="tt">xntpd</literal>.  Si no dispone de una fuente de hora
fiable de forma continua cuando arranque la máquina, puede ser algo
complicado, ya que <literal remap="tt">xntpd</literal> realmente no ha sido diseñado para ser usado
en situaciones como esta. 
</para>

<para>
<literal remap="tt">xntpd</literal> incluye controladores para muchos radio relojes, y puede ser
también puesto en hora llamando periódicamente al servicio telefónico NIST
(asegúrese de calcular el efecto en su cuenta telefónica cuando configure
el intervalo entre llamadas). Esto también sirve para obtener el factor de
corrección al reloj del núcleo si se pierde el contacto con las otras
fuentes de ajuste por un período largo de tiempo.
</para>

<para>
La mayoría de los radio-reloj cuestan $3-4K, pero puede hacer
planes para tener una "caja negra" (actualmente un módem de 300 baudios) 
que esté ubicada entre su computador y una radio de onda corta sintonizada
en la estación de tiempo CHU de Canadá (vea <literal remap="tt"><ulink
url="ftp://ftp.udel.edu/pub.ntp.gadget.tar.Z"
>ftp://ftp.udel.edu/pub.ntp.gadget.tar.Z</ulink
></literal>). 
</para>

<para>
El receptor Heatkit WWV (el "reloj más exacto") está aún disponible
(aunque no como kit), y cuesta alrededor de $4-500. La señal de los
GPS también contiene información de la hora, y algunos receptores de GPS
pueden ser conectados a un puerto serie.  Esto podría constituir una
solución de bajo costo en un futuro cercano.
</para>

<para>
En teoría, cualquiera puede escribir un programa para usar los servicios
telefónicos de NIST, a fin de calcular la variación de tiempo entre el
reloj del CMOS y el del núcleo automáticamente. No tengo noticia de
ningún programa que haga esto por si sólo, pero la mayoría del código
podría obtenerse de <literal remap="tt">xntpd</literal>. 
</para>

</sect1>

<sect1 id="Grupos">
<title>Anexo: El INSFLUG </title>

<para>
El <emphasis>INSFLUG</emphasis> forma parte del grupo internacional 
<emphasis remap="it">Linux Documentation Project</emphasis>, 
encargándose de las traducciones al castellano de los Howtos (Comos),
así como la producción de documentos originales en aquellos casos
en los que no existe análogo en inglés.
</para>

<para>
En el <emphasis remap="bf">INSFLUG</emphasis> se orienta preferentemente a la traducción de documentos
breves, como los <emphasis>COMOs</emphasis> y <emphasis>PUFs</emphasis> (<emphasis remap="bf">P</emphasis>reguntas de
<emphasis remap="bf">U</emphasis>so <emphasis remap="bf">F</emphasis>recuente, las <emphasis remap="it">FAQs</emphasis>. <literal remap="tt">:)</literal> ), etc.
</para>

<para>
Diríjase a la sede del INSFLUG para más información al respecto.
</para>

<para>
En la sede del INSFLUG encontrará siempre las <emphasis remap="bf">últimas</emphasis> versiones 
de las traducciones:  <literal remap="tt"><ulink
url="http://www.insflug.org"
>www.insflug.org</ulink
></literal>. Asegúrese de comprobar cuál es la última versión 
disponible en el Insflug antes de bajar un documento de un servidor réplica.
</para>

<para>
Se proporciona también una lista de los servidores
réplica (<emphasis remap="it">mirror</emphasis>) del Insflug más cercanos a Vd.,  
e información relativa a otros recursos en castellano.
</para>

<para>
Francisco José Montilla, <literal remap="tt"><ulink
url="mailto:pacopepe@insflug.org"
>pacopepe@insflug.org</ulink
></literal>.
</para>

</sect1>

</article>
