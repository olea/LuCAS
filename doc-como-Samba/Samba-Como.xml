<?xml version="1.0" encoding="iso-8859-1" ?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook V4.1.2//EN"
"http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd">

<article>

<articleinfo>

<title>Samba COMO</title>

<author>
<firstname>David Wood, <ulink
url="mailto:dwood@plugged.net.au"
>dwood@plugged.net.au</ulink
>

Traducido por: Ricardo Javier Cárdenes Medina, <ulink
url="mailto:a1402@correo.dis.ulpgc.es"
>a1402@correo.dis.ulpgc.es</ulink
></firstname>
</author>

<pubdate>v1.0, 10 de Agosto de 1996
Traducido a 9 de Octubre de 1996</pubdate>

<abstract>

<para>
Este documento describe la manera de usar el paquete Samba, que dota a Linux
de soporte para el protocolo
<emphasis remap="it">Session Message Block (SMB)</emphasis>, también llamado <emphasis remap="it">NetBIOS</emphasis> o <emphasis remap="it">LanManager</emphasis>.
</para>

</abstract>

</articleinfo>

<sect1>
<title>Introducción</title>

<para>
Este el es SMB COMO. Describe cómo usar el protocolo <emphasis remap="it">Session Message Block 
(SMB)</emphasis>, también llamado protocolo <emphasis remap="it">NetBIOS</emphasis> o <emphasis remap="it">LanManager</emphasis>, con el Linux.
</para>

<para>
Este documento es mantenido por David Wood (<literal remap="tt"><ulink
url="mailto:dwood@plugged.net.au"
>dwood@plugged.net.au</ulink
></literal>). Cualquier añadido, modificación o
corrección puedes enviarla aquí para incluirla en la siguiente entrega.
</para>

<para>
El protocolo SMB es usado por Microsoft Windows 3.11, NT y 95 para compartir 
discos e impresoras. Usando el paquete de herramientas <emphasis remap="it">Samba</emphasis> creado por Andrew 
Tridgell, las máquinas UNIX (incluyendo Linux) pueden compartir discos e 
impresoras con servidores Windows.
</para>

<para>
Hay cuatro cosas que uno puede hacer con <emphasis remap="it">Samba</emphasis>:
</para>

<para>

<orderedlist>
<listitem>

<para>
Compartir una unidad de Linux con máquinas Windows.
</para>
</listitem>
<listitem>

<para>
Compartir una unidad de Windows con máquinas Linux.
</para>
</listitem>
<listitem>

<para>
Compartir una impresora de Linux con máquinas Windows.
</para>
</listitem>
<listitem>

<para>
Compartir una impresora de Windows con máquinas Linux.
</para>
</listitem>

</orderedlist>

</para>

<para>
Todos estos puntos están cubiertos en este documento.
</para>

<para>
Excusatorio: Los procedimientos y scripts le funcionan al autor o se sabe que 
les funciona a la gente que los donó. Algunas configuraciones pueden dar 
problemas con la información que aquí se da. Si te encuentras en tal situación,
puedes mandar un e-mail al autor con sugerencias para mejorar este documento, 
pero el autor no garantiza nada. ¿Qué esperabas? El autor también es un experto,
después de todo...
</para>

</sect1>

<sect1>
<title>Más Información</title>

<para>
Este COMO intenta explicar la configuración de servicios SMB básicos de ficheros
e impresoras en una máquina Linux. <emphasis remap="it">Samba</emphasis> es un paquete muy complejo y completo.
No debería haber razón para duplicar toda la documentación de <emphasis remap="it">Samba</emphasis> aquí.
</para>

<para>
Para mayor información, por favor lee alguno de estos documentos:
</para>

<para>

<itemizedlist>
<listitem>

<para>
La documentación de <emphasis remap="it">Samba</emphasis>, disponible en el paquete de distribución del 
<emphasis remap="it">Samba</emphasis>. El paquete está disponible en:
<literal remap="tt"><ulink
url="ftp://nimbus.anu.edu.au/pub/tridge/samba/"
>ftp://nimbus.anu.edu.au/pub/tridge/samba/</ulink
></literal>
</para>
</listitem>
<listitem>

<para>
El COMO "Imprimiendo en Linux". (Linux Printing HOWTO)
</para>
</listitem>
<listitem>

<para>
El Mini-HOWTO Print2Win.
</para>
</listitem>

</itemizedlist>

</para>

</sect1>

<sect1>
<title>Instalación</title>

<para>
La última versión del código de <emphasis remap="it">Samba</emphasis> está disponible en:
</para>

<para>
<literal remap="tt"><ulink
url="ftp://nimbus.anu.edu.au/pub/tridge/samba/"
>ftp://nimbus.anu.edu.au/pub/tridge/samba/</ulink
></literal>
</para>

<para>
De todas maneras, si has instalado la distribución <emphasis remap="it">RedHat</emphasis> de Linux, tienes la 
opción de instalarlo como paquete. Algunas otras distribuciones también incluyen
los ejecutables de <emphasis remap="it">Samba</emphasis>.
</para>

<para>
Se requieren los dos demonios siguientes para el paquete <emphasis remap="it">Samba</emphasis>. Se suelen instalar en <literal remap="tt">/usr/sbin</literal> y se pueden ejecutar tanto desde los scripts de 
arranque del sistema como desde <literal remap="tt">inetd</literal>. Algunos scripts de ejemplo los
puedes ver en <xref linkend="sec-daemons"/>.
</para>

<para>

<itemizedlist>
<listitem>

<para>
<literal remap="tt">smbd</literal> (El demonio de SMB)
</para>
</listitem>
<listitem>

<para>
<literal remap="tt">nmbd</literal> (Provee un nameserver de NetBIOS para soporte de clientes)
</para>
</listitem>

</itemizedlist>

</para>

<para>
Habitualmente, se instalan en <literal remap="tt">/usr/bin</literal> los siguientes ejecutables de 
<emphasis remap="it">Samba</emphasis>, aunque la localización (como de costumbre) es opcional.
</para>

<para>

<itemizedlist>
<listitem>

<para>
<literal remap="tt">smbclient</literal>       (Un cliente SMB para maquinas UNIX)
</para>
</listitem>
<listitem>

<para>
<literal remap="tt">smbprint</literal>        (Un script para imprimir a una impresora en un servidor SMB)
</para>
</listitem>
<listitem>

<para>
<literal remap="tt">smbprint.sysv</literal>   (Como el de encima, pero para máquinas UNIX SVR4)
</para>
</listitem>
<listitem>

<para>
<literal remap="tt">smbstatus</literal>       (Lista de las conexiones SMB en marcha en el servidor local)
</para>
</listitem>
<listitem>

<para>
<literal remap="tt">smbrun</literal>          (Un script 'cola' para facilitar la ejecución de 
aplicaciones en servidores )
</para>
</listitem>

</itemizedlist>

</para>

<para>
Adicionalmente, se incluye en este COMO un script llamado '<literal remap="tt">print</literal>', que 
sirve como un útil <emphasis remap="it">front end</emphasis> para el script <literal remap="tt">smbprint</literal>.
</para>

<para>
El paquete <emphasis remap="it">Samba</emphasis> es sencillo de instalar. Simplemente consigue el código fuente
del servidor que nombramos antes, y lee el fichero <literal remap="tt">README</literal> de la distribución.
Hay también un fichero llamado <literal remap="tt">docs/INSTALL.txt</literal> en la distribución 
que te da un sencillo conjunto de instrucciones paso a paso.
</para>

<para>
Siguiendo con la instalación, pon los demonios en <literal remap="tt">/usr/sbin</literal> y los 
ejecutables en <literal remap="tt">/usr/bin</literal>. Instala las páginas del manual en <literal remap="tt">/usr/local/man</literal>.
</para>

<para>
Cuando compiles el paquete <emphasis remap="it">Samba</emphasis>, deberías especificar en el <literal remap="tt">Makefile</literal> la 
localización del fichero de configuración, <literal remap="tt">smb.conf</literal>. Generalmente debería 
estar en <literal remap="tt">/etc</literal>, pero puedes ponerlo donde quieras. A estas alturas,
presumimos que especificaste la localización del fichero de configuración 
como <literal remap="tt">/etc/smb.conf</literal>, el fichero de registro como <literal remap="tt">/var/log/samba-log.%m</literal> y el directorio de bloqueo como <literal remap="tt">/var/lock/samba</literal>
</para>

<para>
Instala el fichero de configuración, <literal remap="tt">smb.conf</literal>. Ve al directorio donde se 
compiló el <emphasis remap="it">Samba</emphasis>. Mira en el directorio <literal remap="tt">examples/simple</literal> y lee el 
fichero <literal remap="tt">README</literal>. En ese directorio encontrarás el fichero <literal remap="tt">smb.conf</literal>. 
Cópialo en <literal remap="tt">/etc</literal>. ¡TEN CUIDADO! Si tienes una distribución de Linux que
tiene el <emphasis remap="it">Samba</emphasis> instalado ya, puede que ya tengas un fichero de configuración en
<literal remap="tt">/etc</literal>. Probablemente deberías usar el antiguo.
</para>

<para>
Si no quieres que tu configuración esté en <literal remap="tt">/etc</literal>, ponla donde quieras 
y luego pon un enlace simbólico en <literal remap="tt">/etc</literal>:
</para>

<para>

<screen>
	ln -s /path/to/smb.conf /etc/smb.conf
</screen>

</para>

</sect1>

<sect1 id="sec-daemons">
<title>Ejecutando los demonios</title>

<para>
Los dos demonios de SMB son <literal remap="tt">/usr/bin/smbd</literal> y <literal remap="tt">/usr/sbin/nmbd</literal>.
</para>

<para>
Puedes ejecutar los demonios de <emphasis remap="it">Samba</emphasis> desde <literal remap="tt">inetd</literal> o como procesos independientes
. Si estás configurando un servidor de ficheros permanente, deberían ejecutarse
desde <literal remap="tt">inetd</literal> para que sean reejecutados si 'mueren'. Si solo quieres usar los 
servicios SMB de vez en cuando o como ayuda a la administración del sistema, 
puedes ejecutarlos con un script en <literal remap="tt">/etc/rc.d/init.d</literal> o incluso a mano 
cuando los necesites.
</para>

<para>
Para ejecutar los demonios desde <literal remap="tt">inetd</literal>, pon las siguientes líneas en el 
fichero de configuración de <literal remap="tt">inetd</literal>, <literal remap="tt">/etc/inetd.conf</literal>:
</para>

<para>

<screen>
    # Servicios SAMBA NetBIOS (para compartición de ficheros e impresoras en PC)
    netbios-ssn stream tcp nowait root /usr/sbin/smbd smbd
    netbios-ns dgram udp wait root /usr/sbin/nmbd nmbd
</screen>

</para>

<para>
Entonces reejecuta <literal remap="tt">inetd</literal> con el siguiente comando:
</para>

<para>

<screen>
    kill -HUP 1
</screen>

</para>

<para>
Para ejecutarlos desde los scripts de inicio del sistema, pon las siguientes 
líneas en <literal remap="tt">/etc/rc.d/init.d/smb</literal> y hazle un enlace simbólico con los 
ficheros indicados en los comentarios:
</para>

<para>

<programlisting>
    #!/bin/sh
    #
    # /etc/rc.d/init.d/smb - comienza y termina los servicios SMB.
    #
    # Se deben crear los siguientes ficheros como enlaces simbolicos a este fichero:
    # symlinks: /etc/rc.d/rc1.d/K35smb  (Termina los servicios SMB al cerrar el sistema)
    #           /etc/rc.d/rc3.d/S91smb  (Comienza los servicios SMB en modo multiusuario)
    #           /etc/rc.d/rc6.d/K35smb  (Termina los servicios SMB al hacer un reboot)
    #

    # Libreria de funciones
    . /etc/rc.d/init.d/functions

    # Configuracion de red
    . /etc/sysconfig/network

    # Asegurarse que la red esta a punto
    [ ${NETWORKING} = "no" ] &amp;&amp; exit 0

    # Comprobar como fuimos llamados
    case "$1" in
      empezar)
	echo -n "Poniendo en marcha los servicios SMB: "
	daemon smbd -D  
	daemon nmbd -D 
	echo
	touch /var/lock/subsys/smb
	;;
      parar)
	echo -n "Terminando los servicios SMB: "
	killproc smbd
	killproc nmbd
	rm -f /var/lock/subsys/smb
	echo ""
	;;
      *)
	echo "Modo de uso: smb {empezar|parar}"
	exit 1
    esac


</programlisting>

</para>

</sect1>

<sect1>
<title>Configuración General (<literal remap="tt">/etc/smb.conf</literal>)</title>

<para>
La configuración de <emphasis remap="it">Samba</emphasis> en un Linux (u otra máquina UNIX) es controlada por un
solo fichero, <literal remap="tt">/etc/smb.conf</literal>. Este fichero determina qué recursos del
sistema quieres compartir con el mundo exterior y que restricciones deseas poner
en ellos.
</para>

<para>
Como las siguientes secciones 'direccionarán' la compartición de unidades e
impresoras de Linux con máquinas Windows, el fichero <literal remap="tt">smb.conf</literal> mostrado en 
esta sección es lo más simple posible, solo para propósitos introductorios.
</para>

<para>
No te preocupes por los detalles, aún. Otras secciones más adelante introducirán
los conceptos más importantes.
</para>

<para>
Cada sección del fichero empieza con una cabecera como <literal remap="tt">[global], [impresoras]</literal>, etc.
</para>

<para>
La sección <literal remap="tt">[global]</literal> define unas pocas variables que <emphasis remap="it">Samba</emphasis> usará para 
definir la compartición de todos los recursos.
</para>

<para>
La sección <literal remap="tt">[homes]</literal> permite a los usuarios remotos acceder a sus 
respectivos directorios principales en la máquina Linux local (cada uno al suyo 
nada más). Esto es, si un usuario de Windows intenta conectar a este recurso 
desde su máquina Windows, será conectado a su directorio personal. A tener en cuenta que para hacer esto, tiene que tener una cuenta en la máquina Linux. ;-)
</para>

<para>
El fichero <literal remap="tt">smb.conf</literal> que viene debajo como ejemplo permite a los usuarios
remotos acceder a su directorio principal en la máquina local y escribir en un
directorio temporal. Para que un usuario de Windows vea estos recursos, la 
máquina Linux debe estar en la red local. Entonces el usuario simplemente 
conecta una unidad de red desde el <emphasis remap="it">Explorador de Windows</emphasis> o el <emphasis remap="it">Windows File Manager</emphasis>.
</para>

<para>
Fíjate que en las siguientes secciones, se darán entradas adicionales a este 
fichero para permitir la compartición de más recursos.
</para>

<para>

<programlisting>

; /etc/smb.conf
;
; Reinicia el servidor cada vez que hagas cambios a este fichero, ej:
; /etc/rc.d/init.d/smb parar
; /etc/rc.d/init.d/smb empezar

[global]
; Quita el comentario a la siguiente linea si quieres cuentas de invitado
; guest account = nobody
   log file = /var/log/samba-log.%m
   lock directory = /var/lock/samba
   share modes = yes

[homes]
   comment = Directorios principales
   browseable = no
   read only = no
   create mode = 0750

[tmp]
   comment = Espacio de ficheros temporales
   path = /tmp
   read only = no
   public = yes


</programlisting>


</para>

</sect1>

<sect1>
<title>Compartiendo Una Unidad Linux Con Máquinas Windows</title>

<para>
Como se muestra en el fichero <literal remap="tt">smb.conf</literal> anterior, compartir una unidad 
Linux con usuarios Windows es fácil. De todas maneras, como todo lo demás con 
<emphasis remap="it">Samba</emphasis>, puedes tener las cosas MUY controladas. Aquí tienes unos pocos ejemplos:
</para>

<para>
Para compartir un directorio con todo el mundo, crea una copia de la sección <literal remap="tt">[tmp]</literal> añadiendo algo como esto al <literal remap="tt">smb.conf</literal>:
</para>

<para>

<programlisting>

[public]
   comment = Cosas publicas
   path = /home/public
   public = yes
   writable = yes
   printable = yes


</programlisting>

</para>

<para>
Para que este directorio lo pueda leer todo el mundo, pero que sólo lo puedan
cambiar gente del grupo 'laborales', modifica la entrada de esta manera:
</para>

<para>

<programlisting>

[public]
   comment = Cosas publicas
   path = /home/public
   public = yes
   writable = yes
   printable = no
   write list = @laborales


</programlisting>

</para>

<para>
Para aprender otros truquillos con que jugar con las unidades compartidas, 
mira la documentación de <emphasis remap="it">Samba</emphasis> o las páginas del man.
</para>

</sect1>

<sect1>
<title>Compartiendo Una Unidad Windows Con Máquinas Linux</title>

<para>
Se incluye un programa cliente de SMB para máquinas UNIX con la distribución de <emphasis remap="it">Samba</emphasis>. Provee un interfaz estilo <literal remap="tt">ftp</literal> para la línea de comandos. Puedes usar esta
utilidad para transferir ficheros entre un 'servidor' Windows y un cliente unix.
</para>

<para>
Para ver qué recursos están disponibles en un host dado, ejecuta:
</para>

<para>

<screen>
    /usr/sbin/smbclient -L host
</screen>

</para>

<para>
donde 'host' es el nombre de la máquina que quieres 'ver'. Esto devolverá un 
lista de nombres de 'servicios' --esto es, nombres de unidades o impresoras que
puede compartir contigo--. A menos que el servidor SMB no tenga la seguridad 
configurada, te preguntará por una clave. Dale la clave de la cuenta de 'invitados' o de tu cuenta personal en esa máquina.
</para>

<para>
Por ejemplo:
</para>

<para>

<screen>
    smbclient -L zimmerman
</screen>

</para>

<para>
La salida de este comando debería ser algo parecido a esto:
</para>

<para>

<screen>
Server time is Sat Aug 10 15:58:27 1996
Timezone is UTC+10.0
Password: 
Domain=[WORKGROUP] OS=[Windows NT 3.51] Server=[NT LAN Manager 3.51]

Server=[ZIMMERMAN] User=[] Workgroup=[WORKGROUP] Domain=[]

	Sharename      Type      Comment
	---------      ----      -------
	ADMIN$         Disk      Remote Admin
	public         Disk      Public 
	C$             Disk      Default share
	IPC$           IPC       Remote IPC
	OReilly        Printer   OReilly
	print$         Disk      Printer Drivers


This machine has a browse list:

	Server               Comment
	---------            -------
	HOPPER               Samba 1.9.15p8
	KERNIGAN             Samba 1.9.15p8
	LOVELACE             Samba 1.9.15p8
	RITCHIE              Samba 1.9.15p8
	ZIMMERMAN            
</screen>

</para>

<para>
La lista muestra otros servidores SMB con recursos para compartir con la red.
</para>

<para>
Para usar el cliente, ejecuta:
</para>

<para>

<screen>
    /usr/sbin/smbclient servicio &#60;password&#62;
</screen>

</para>

<para>
donde 'servicio' es una máquina y un servicio. Por ejemplo, si estás intentando
entrar en un directorio que ha sido compartido como '<literal remap="tt">public</literal>' en una 
máquina llamada <literal remap="tt">zimmerman</literal>, el servicio debería llamarse &bsol;&bsol;zimmerman&bsol;public. De todas maneras, debido a restricciones del shell, necesitarás
poner las barras invertidas con secuencias de escape, por lo que al final 
saldrá algo parecido a esto:
</para>

<para>

<screen>
    /usr/sbin/smbclient \\\\zimmerman\\public miclave
</screen>

</para>

<para>
donde '<literal remap="tt">miclave</literal>' es una cadena literal con tu password.
</para>

<para>
Entonces te aparecerá el 'prompt' del smbclient:
</para>

<para>

<screen>
Server time is Sat Aug 10 15:58:44 1996
Timezone is UTC+10.0
Domain=[WORKGROUP] OS=[Windows NT 3.51] Server=[NT LAN Manager 3.51]
smb: \&#62; 
</screen>

</para>

<para>
Escribe 'h' para obtener una ayuda de como usar el cliente:
</para>

<para>

<screen>
smb: \&#62; h
ls             dir            lcd            cd             pwd            
get            mget           put            mput           rename         
more           mask           del            rm             mkdir          
md             rmdir          rd             prompt         recurse
translate      lowercase      print          printmode      queue          
cancel         stat           quit           q              exit           
newer          archive        tar            blocksize      tarmode        
setmode        help           ?              !              
smb: \&#62; 
</screen>

</para>

<para>
Si sabes usar el ftp, no deberías necesitar las páginas del man del <literal remap="tt">smbclient</literal>.
</para>

</sect1>

<sect1>
<title>Compartiendo Una Impresora Linux Con Máquinas Windows</title>

<para>
Para compartir una impresora Linux con máquinas Windows, necesitas asegurarte 
de que la impresora está preparada para trabajar bajo Linux. Si puedes imprimir
desde Linux, preparar una 'compartición' SMB de la impresora es automático.
</para>

<para>
Mírate el COMO Imprimir (Printing HOWTO) para poner a punto la impresora con 
Linux.
</para>

<para>
Como el autor usa una impresora conectada a una máquina Windows NT, esta sección
no debería ser vista como algo definitivo, sino como mera sugerencia. 
Cualquiera que tenga detalles que compartir con el autor, por favor, que los 
mande a
<literal remap="tt"><ulink
url="mailto:dwood@plugged.net.au"
>dwood@plugged.net.au</ulink
></literal>
para que esta sección pueda ser completada.
</para>

<para>
Añade la configuración de la impresora a tu <literal remap="tt">smb.conf</literal>:
</para>

<para>

<programlisting>

[global]
   printing = bsd
   printcap name = /etc/printcap
   load printers = yes
   log file = /var/log/samba-log.%m
   lock directory = /var/lock/samba

[printers]
   comment = Todas las impresoras
   security = server
   path = /var/spool/lpd/lp
   browseable = no
   printable = yes
   public = yes
   writable = no
   create mode = 0700

[ljet]
   security = server
   path = /var/spool/lpd/lp
   printer name = lp
   writable = yes
   public = yes
   printable = yes
   print command = lpr -r -h -P %p %s


</programlisting>

</para>

<para>
¡Asegúrate de que el 'path' de la impresora (en este caso bajo <literal remap="tt">[ljet]</literal>)
se corresponde al directorio de '<emphasis remap="it">spool</emphasis>' en <literal remap="tt">/etc/printcap</literal>!
</para>

<para>
NOTA: Hay algunos problemas compartiendo impresoras conectadas a UNIX con 
máquinas Windows NT usando <emphasis remap="it">Samba</emphasis>. Un problema es que NT 'vea' la impresora 
compartida correctamente. Para conseguirlo, mírate las notas en la distribución 
de <emphasis remap="it">Samba</emphasis> en el fichero <literal remap="tt">docs/WinNT.txt</literal>. El otro va con problemas con 
las claves. Mírate los comentarios en ese mismo fichero para conseguir una 
molesta ganancia de conocimientos y fallos (jejeje) para arreglar el problema.
</para>

</sect1>

<sect1>
<title>Compartiendo Una Impresora Windows Con Máquinas Linux</title>

<para>
Para compartir una impresora en una máquina Windows, debes hacer lo siguiente:
</para>

<para>
a) Debes tener las entradas adecuadas en <literal remap="tt">/etc/printcap</literal> y deben 
corresponderse a la estructura de directorios local (el directorio de spool, 
etc)
</para>

<para>
b) Debes tener el script <literal remap="tt">/usr/bin/smbprint</literal>. Viene con las fuentes de 
<emphasis remap="it">Samba</emphasis>, pero no con la distribución de ejecutables del <emphasis remap="it">Samba</emphasis>. Más abajo 
comentamos una copia ligeramente modificada.
</para>

<para>
c) Si quieres convertir ficheros ASCII a PostScript, debes tener el 'nenscript'
o su equivalente. <literal remap="tt">nenscript</literal> es un conversor de PostScript y habitualmente
está instalado en <literal remap="tt">/usr/bin</literal>.
</para>

<para>
d) Puedes desear que las impresiones de <emphasis remap="it">Samba</emphasis> sean más sencillas teniendo un 
<emphasis remap="it">front end</emphasis> fácil de usar. Más abajo tienes un sencillo script en <emphasis remap="it">perl</emphasis> 
para manejar ASCII, PostScript o PostScript generado.
</para>

<para>
La entrada para <literal remap="tt">/etc/printcap</literal> que tenemos debajo es para una 
impresora HP 5MP en un host Windows NT. Las entradas son las siguientes:
</para>

<para>

<programlisting>

	cm - comentario
	lp - nombre del dispositivo a abrir para salida
	sd - el directorio de spool de la impresora (en la máquina local)
	af - el fichero de cuentas
	mx - el tamano maximo del fichero (cero es ilimitado)
	if - nombre del fichero de entrada (script)


</programlisting>

</para>

<para>
Para más información, lee el <emphasis remap="it">COMO Imprimir (Printing HOWTO)</emphasis> o la página del
man de <literal remap="tt">printcap</literal>.
</para>

<para>

<programlisting>

# /etc/printcap
#
# //zimmerman/oreilly via smbprint
#
lp:\
	:cm=HP 5MP PostScript OReilly en zimmerman:\
	:lp=/dev/lp1:\
	:sd=/var/spool/lpd/lp:\
	:af=/var/spool/lpd/lp/acct:\
	:mx#0:\
	:if=/usr/bin/smbprint:


</programlisting>

</para>

<para>
Asegúrate de que los directorios de <emphasis remap="it">spool</emphasis> y cuentas existe y se puede
escribir en ellos. Asegura también que la línea '<literal remap="tt">if</literal>' tiene el path
adecuado para el script <literal remap="tt">smbprint</literal> (que damos debajo) y que <emphasis remap="it">apunta</emphasis> al
dispositivo adecuado. (el fichero <literal remap="tt">/dev</literal> especial).
</para>

<para>
Lo siguiente es el propio script <literal remap="tt">smbprint</literal>. Normalmente está en <literal remap="tt">/usr/bin</literal> y es atribuible a Andrew Tridgell, la persona que creó el <emphasis remap="it">Samba</emphasis> (que yo
sepa). Viene con la distribución de las fuentes del <emphasis remap="it">Samba</emphasis>, pero está ausente de
algunas distribuciones de ejecutables, por lo que lo he recreado aquí.
</para>

<para>
Te podría interesar mirarlo con cuidado. Hay algunas pequeñas alteraciones que 
han demostrado ser útiles.
</para>

<para>

<programlisting>

#!/bin/sh -x

# Este script es un filtro de entrada para la impresion de printcap en
# una maquina unix. Usa el programa smbclient para imprimir un fichero
# en el servidor y servicio basados en smb especificados.
# Por ejemplo, puedes tener una entrada en printcap como esta
#
# smb:lp=/dev/null:sd=/usr/spool/smb:sh:if=/usr/local/samba/smbprint
#
# que creara una impresora unix llamada "smb" que imprimira a traves de
# este script. Necesitarras crear el directorio de spool /usr/spool/smb
# con los permisos y pertenencias apropiados para tu sistema.

# Ahora preparalos con el servidor y servicio en que quieras imprimir
# En este ejemplo tengo un PC WfWg llamado "lapland" que tiene una
# impresora exportada llamada "printer" sin password.

#
# Script alterado por hamilton@ecnz.co.nz (Michael Hamilton)
# para que servicio, servidor y clave puedan ser leidos desde un
# fichero /usr/var/spool/lpd/PRINTNAME/.config
#
# Para que esto funcione la entrada en /etc/printcap debe incluir un
# fichero de cuentas (af=...):
#
#   cdcolour:\
#       :cm=CD IBM Colorjet on 6th:\
#       :sd=/var/spool/lpd/cdcolour:\
#       :af=/var/spool/lpd/cdcolour/acct:\
#       :if=/usr/local/etc/smbprint:\
#       :mx=0:\
#       :lp=/dev/null:
#
# El fichero /usr/var/spool/lpd/PRINTNAME/.config deberia contener:
#   servidor=SERVIDOR_PC
#   servicio=NOMBRE_IMP
#   clave="clave"
#
# Ej.
#   servidor=PAULS_PC
#   servicio=CJET_371
#   clave=""

#
# Fichero de registro para correcciones, cambiar a /dev/null si se quiere
#
fichreg=/tmp/smb-print.log
# fichreg=/dev/null


#
# El ultimo parametro para el filtro es el nombre del fichero de
# cuentas
#
dir_spool=/var/spool/lpd/lp
fich_config=$dir_spool/.config

# Deberia leer las siguientes variables activadas en el fichero de
# configuracion:
#   servidor
#   servicio
#   clave
#   usuario
eval `cat $fich_config`

#
# Algo de ayuda en la correccion de errores. Cambia el &#62;&#62; por &#62; si
# quieres salvar algo de espacio.
#
echo "servidor $servidor, servicio $servicio" &#62;&#62; $fichreg

(
# NOTA: Puede que quieras anadir la linea `echo translate' si quieres CR/LF
# automatico cuando imprimes.
	echo translate
	echo "print -"
	cat
) | /usr/bin/smbclient "\\\\$servidor\\$servicio" $clave -U $usuario -N -P &#62;&#62; $fichreg


</programlisting>

</para>

<para>
La mayoría de las distribuciones de Linux vienen con el <literal remap="tt">nenscript</literal> para convertir
los documentos ASCII a Postscript. El siguiente script <literal remap="tt">perl</literal> hace la vida más
fácil dando un interfaz sencillo para que linux imprima a través de smbprint.
</para>

<para>

<programlisting>

Forma de uso: print [-a|c|p] &#60;nombre_fichero&#62;
              -a imprime &#60;nombre_fichero&#62; como ASCII
              -c imprime &#60;nombre_fichero&#62; formateado como codigo fuente
              -p imprime &#60;nombre_fichero&#62; como Postscript
      Si no se pasa ningun parametro, print intenta
      averiguar el tipo de fichero e imprimirlo
      adecuadamente.


</programlisting>

</para>

<para>
<literal remap="tt">smbprint</literal> tiende a truncar las líneas demasiado largas cuando imprime 
ficheros ASCII. Este rompe las líneas largas donde haya un espacio en blanco 
(en lugar de en mitad de una palabra), si es posible.
</para>

<para>
El formateado de código fuente se hace con <literal remap="tt">nenscript</literal>. Coge un fichero ASCII
y lo formatea en 2 columnas con una cabecera mu' mona (fecha, nombre de fichero
, etc). Además enumera las líneas. Usándolo como ejemplo, se pueden lograr otros
tipos de formateado.
</para>

<para>
Los documentos Postscript también se imprimen correctamente, por lo que pasan directamente.
</para>

<para>

<programlisting>

#!/usr/bin/perl

# Script:   print
# Autores:  Brad Marshall, David Wood
#           Plugged In Communications
# Fecha:    960808
# Cambios:  Ricardo Javier Cardenes Medina
# Razon:	Traduccion de comentarios y codigo a espanol para
#		mayor comprension.
# Fecha:    961109 (Sab 9 de Noviembre de 1996)
#
# Script para imprimir a Oreilly que esta actualmente en zimmerman.
# Proposito: Toma ficheros de varios tipos como parametros y
# los procesa apropiadamente para mandarlos al script de impresion de Samba.
#
# Tipos soportados actualmente:
# 
# ASCII      - Asegura que las lineas con mas de $largo_linea caracteres seran
#              divididas aprovechando los espacios en blanco.
# PostScript - No hace nada.
# Codigo     - Lo formatea en PostScript (usando nenscript) para una mejor
#              presentacion (fuente, etc...).
#

# Maxima longitud permitida para cada linea de texto ASCII.
$largo_linea = 76;

# Path y nombre del script 'print' de Samba.
$prog_print = "/usr/bin/smbprint";

# Path y nombre del nenscript (el convertidor ASCII--&#62;PostScript)
$nenscript = "/usr/bin/nenscript";

unless ( -f $prog_print ) {
	die "¡No encuentro $prog_print!";
}
unless ( -f $nenscript ) {
	die "¡No encuentro $nenscript!";
}

&amp;InterpLinCom(@ARGV);

# DBG
print "El tipo de fichero es $tipofich\n";

if ($tipofich eq "ASCII") {
	&amp;Rompe($largo_linea);
} elsif ($tipofich eq "codigo") {
	&amp;FormateaCodigo;
} elsif ($tipofich eq "postscript") {
	&amp;CreaTabla;
} else {
	print "Lo siento..tipo de fichero desconocido.\n";
	exit 0;
}
# Enviar el array a smbprint
open(IMPRESORA, "|$prog_print") || die "¡No puedo abrir $prog_print: $!\n";
foreach $linea (@newlines) {
	print IMPRESORA $linea;
}
# Enviar un avance de linea extra en caso de que el fichero tenga una
# ultima linea incompleta.
print IMPRESORA "\n";
close(IMPRESORA);
print "Terminado\n";
exit 0;

# --------------------------------------------------- #
#         Todo lo de debajo es una subrutina          #
# --------------------------------------------------- #

sub InterpLinCom {
	# Interpreta la linea de comando, averiguando el tipo de fichero

	# Toma $par y $fich como parametro (si existe) y nombre del
	# fichero.
	if ($#_ &#60; 0) {
		&amp;FormaUso;
	}
	# DBG
	#       foreach $elemento (@_) {
	#               print "*$elemento* \n";
	#       }

	$par = shift(@_);
	if ($par =~ /\-./) {
		$com = $par;
	# DBG
	#       print "\Encontrado $com.\n";

		$fich = shift(@_);
	} else {
		$fich = $par;
	}
	
	# Defining the file type
	unless ($com) {
		# No tenemos parámetro

		if ($fich =~ /\.ps$/) {
			$tipofich = "postscript";
		} elsif ($fich =~ /\.java$|\.c$|\.h$|\.pl$|\.sh$|\.csh$|\.m4$|\.inc$|\.html$|\.htm$/) {
			$tipofich = "codigo";
		} else {
			$tipofich = "ASCII";
		}

		# Procesa $fich buscando el tipo y devuelve $tipofich
	} else {
		# Tenemos el tipo en $par
		if ($com =~ /^-p$/) {
			$tipofich = "postscript";
		} elsif ($com =~ /^-c$/) {
			$tipofich = "codigo";
		} elsif ($com =~ /^-a$/) {
			$tipofich = "ASCII"
		}
	}
}

sub FormaUso {
	print "
Forma de uso: print [-a|c|p] &#60;nombre_fichero&#62;
              -a imprime &#60;nombre_fichero&#62; como ASCII
              -c imprime &#60;nombre_fichero&#62; formateado como codigo fuente
              -p imprime &#60;nombre_fichero&#62; como Postscript
      Si no se pasa ningun parametro, print intenta
      averiguar el tipo de fichero e imprimirlo
      adecuadamente.\n
";
	exit(0);
}

sub Rompe {
	# Crea una tabla con las lineas del fichero, donde cada linea es
	# menor que el numero de caracteres especificado, y las rompe
	# solo en los espacios en blanco

	# Toma el numero de caracteres a los que limitar la linea.
	$limite = pop(@_);

	# DBG
	#print "Entrando en la subrutina Rompe\n";
	#print "El limite de caracteres es $limit\n";

	# Lee en el fichero, lo interpreta y pone en la tabla.
	open(FICHERO, "&#60;$fich") || die "¡No puedo abrir $fich: $!\n";
	while(&#60;FICHERO&#62;) {
		$linea = $_;
		
		# DBG
		#print "La linea es:\n$linea\n";

		# Rompe la linea si se pasa del limite.
		while ( length($linea) &#62; $limite ) {
			
			# DBG
			#print "Rompiendo...";

			# Toma los primeros $limite +1 caracteres.
			$cacho = substr($linea,0,$limite +1);

			# DBG
			#print "La linea parcial es:\n$cacho\n";

			# Mira a ver si el ultimo caracter es un espacio.
			$ultimo_car = substr($cacho,-1, 1);
			if ( " " eq $ultimo_car ) {
			    # Si lo es, imprime el resto.

			    # DBG
			    #print "El ultimo caracter era un espacio\n";

			    substr($linea,0,$limite + 1) = "";
			    substr($cacho,-1,1) = "";
			    push(@newlines,"$cacho\n");
			} else {
			     # Si no lo es, busca el ultimo espacio en la
			     # sub-linea e imprime hasta alli.

			    # DBG
			    #print "El ultimo caracter no era un espacio\n";

			     # Borra el ultimo caracter que pasa de $limite
			     substr($cacho,-1,1) = "";
			     # Da la vuelta a la linea para hacer mas
			     # sencillo buscar el espacio.
			     $cachoreves = reverse($cacho);
			     $indice = index($revpart," ");
			     if ( $indice &#62; 0 ) {
			       substr($linea,0,$limite-$indice) = "";
			       push(@newlines,substr($cacho,0,$limite-$indice) 
				   . "\n");
			     } else {
				 # No hay espacios en la linea, por lo que
				 # se imprime hasta $limite.
			       substr($linea,0,$limite) = "";
			       push(@newlines,substr($cacho,0,$limite) 
				   . "\n");
			     }
			}
		}
		push(@newlines,$linea);
	}
	close(FICHERO);
}

sub FormateaCodigo {
	# Llama a la subrutina Rompe cuando filtra a traves de nenscript
	&amp;Rompe($largo_linea);
	
	# Manda los resultados a traves de nenscript para crear un
	# fichero Postscript que de una forma decente a nuestro codigo
	# fuente para imprimirlo (fuente Courier, numero de lineas, ...).
	# E imprime todo esto a un fichero temporal.
	$fichtmp = "/tmp/nenscript$$";
	open(FICHERO, "|$nenscript -2G -i$fich -N -p$fichtmpfich -r") || 
		die "¡No pude abrir nenscript: $!\n";
	foreach $linea (@newlines) {
		print FICHERO $linea;
	}
	close(FICHERO);
	
	# Vuelca el fichero temporal en una tabla para que pueda
	# ser pasado al script de impresion de Samba.
	@newlines = ("");
	open(FICHERO, "&#60;$fichtmp") || die "¡No puedo abrir $fichtmp: $!\n";
	while(&#60;FICHERO&#62;) {
		push(@newlines,$_);
	}
	close(FICHERO);
	system("rm $fichtmp");
}

sub CreaTabla {
	# Crear la tabla para postscript
	open(FICHERO, "&#60;$fich") || die "¡No puedo abrir $fich: $!\n";
	while(&#60;FICHERO&#62;) {
		push(@newlines,$_);
	}
	close(FICHERO);
}


</programlisting>

</para>

</sect1>

<sect1>
<title>Copyright</title>

<para>
This HOWTO is copyright 1996 by David Wood.  It may be reproduced in any form 
and freely distributed as long as the file stays intact, including this 
statement.
</para>

<para>
Este COMO tiene un copyright de 1996 por David Wood. Puede ser reproducido en 
cualquier forma y distribuido libremente mientras el fichero se mantenga intacto
, incluyendo esta línea.
</para>

</sect1>

<sect1>
<title>Reconocimientos</title>

<para>
Tan pronto como me mandes sugerencias, te pondré aquí en la siguiente entrega.
</para>

</sect1>

<sect1>
<title>Notas sobre/del traductor</title>

<para>
Este es mi primer trabajo para el INSFLUG, grupo del que tuve conocimiento esta misma semana (esto fue escrito el sábado 9 de noviembre de 1996). Para que veáis que aquí nos damos prisa con las cosas y que esto va rápido.
</para>

<para>
Ricardo Cárdenes es un simple estudiante de la E.U. de Informática en la ULPGC (Universidad de Las Palmas de Gran Canaria).
</para>

<para>
Ahora mismo está en su tercer año y tiene dos cosas que agradecer a la uni: 
Internet y el LiNUX. La primera la tiene presente desde el primer mes en la 
escuela. El segundo lo descubrió y empezó a quererlo y mimarlo desde
que se vio obligado a ceder casi la mitad de su disco duro (210MB -sigh!-) para poder cumplir con unas prácticas de S. Operativos en mitad del segundo curso 
(hasta ahora no se ha arrepentido)
</para>

<para>
Cualquier donación para la compra de un nuevo disco duro y poder rebajar el 
88-95% de ocupación que se mantiene constantemente en las particiones, y así 
poder dedicarse con más holgura a la traducción de COMOs, FAQs y
cosas de esas que tan bien os vienen, será bien recibida &rcub;8-)))))
</para>

<para>
Si quieres contactar con él por alguna de esas extrañas razones de la vida 
(por ejemplo, una donación para su nuevo disco duro 8-))))), podéis dejarle un 
mensaje aquí: <literal remap="tt"><ulink
url="mailto:a1402@correo.dis.ulpgc.es"
>a1402@correo.dis.ulpgc.es</ulink
></literal>
</para>

</sect1>

<sect1 id="Grupos">
<title>Anexo: El INSFLUG </title>

<para>
El <emphasis>INSFLUG</emphasis> forma parte del grupo internacional 
<emphasis remap="it">Linux Documentation Project</emphasis>, 
encargándose de las traducciones al castellano de los Howtos (Comos),
así como la producción de documentos originales en aquellos casos
en los que no existe análogo en inglés.
</para>

<para>
En el <emphasis remap="bf">INSFLUG</emphasis> se orienta preferentemente a la traducción de documentos
breves, como los <emphasis>COMOs</emphasis> y <emphasis>PUFs</emphasis> (<emphasis remap="bf">P</emphasis>reguntas de
<emphasis remap="bf">U</emphasis>so <emphasis remap="bf">F</emphasis>recuente, las <emphasis remap="it">FAQs</emphasis>. <literal remap="tt">:)</literal> ), etc.
</para>

<para>
Diríjase a la sede del INSFLUG para más información al respecto.
</para>

<para>
En la sede del INSFLUG encontrará siempre las <emphasis remap="bf">últimas</emphasis> versiones 
de las traducciones:  <literal remap="tt"><ulink
url="http://www.insflug.org"
>www.insflug.org</ulink
></literal>. Asegúrese de comprobar cuál es la última versión 
disponible en el Insflug antes de bajar un documento de un servidor réplica.
</para>

<para>
Se proporciona también una lista de los servidores
réplica (<emphasis remap="it">mirror</emphasis>) del Insflug más cercanos a Vd.,  
e información relativa a otros recursos en castellano.
</para>

<para>
Francisco José Montilla, <literal remap="tt"><ulink
url="mailto:pacopepe@insflug.org"
>pacopepe@insflug.org</ulink
></literal>.
</para>

</sect1>

</article>
