 <Chapter Id="install">
  <Title>Instalación</Title>

  <Abstract>
   <Para>
    Instrucciones para la instalación de
    <ProductName>PostgreSQL</ProductName> 7.0.
   </Para>
  </Abstract>

  <Para>
   Los comandos que se mencionana acontinuación fueron probados utilizando
   el shell <filename>bash</filename> sobre la distribución RedHat 5.2 de Linux.
   A menos que se indique lo conrario, estos comandos serán igualmente aplicables
   para la mayoría de los sistemas. Comandos como <command>ps</command> y
   <command>tar</command> pueden variar entre las distintas plataformas en 
   cuanto a las opciones que deben usarse. <Emphasis>Utilice su sentido 
   común</Emphasis> antes de teclear cualquiera de stos comandos.
  </Para>

  <Para>
   Si aún no tiene la distribución de <ProductName>PostgreSQL</ProductName>,
   puede obteneral en <ULink url="ftp://ftp.postgresql.org">ftp.postgresql.org</ULink>.
   Una vez obtenida, desempaquetela utilizando los siguientes comandos:
<ProgramListing>
$ gunzip postgresql-7.0.tar.gz
$ tar -xf postgresql-7.0.tar
$ mv postgresql-7.0 /usr/src
</ProgramListing>
   Nuevamente, estos comandos pueden ser distintos en su sistema.
  </Para>

  <Sect1>
   <Title>Antes de comenzar</Title>

  <Para>
   Para compilar <Productname>PostgreSQL</Productname> se requiere la utilidad 
   <acronym>GNU</acronym> <Application>make</Application>. Otras utilidades similares
   <Emphasis>no funcionarán</Emphasis> en este caso. En los sistemas GNU/Linux,
   <acronym>GNU</acronym> <Application>make</Application> es a herramienta por defecto.
   En otros sistemas puede que encuentre que la herramienta <acronym>GNU</acronym>
   <Application>make</Application> se encuentre instalada con el nombre <Quote>gmake</Quote>.
   De aquí en adelante, utilizaremos este nombre para referirnos a 
   <acronym>GNU</acronym> <Application>make</Application>, sin importar cuál sea el nombre 
   que tiene en su sistema. Para probar <acronym>GNU</acronym> <Application>make</Application> 
   teclee:
<programlisting>
$ <userinput>gmake --version</userinput>
</programlisting>
   Si necesita obtener <acronym>GNU</acronym> <Application>make</Application>,
   lo puede encontrar en <ULink url="ftp://ftp.gnu.org">ftp://ftp.gnu.org</ULink>.
  </Para>

   <Para>
    En <ulink url="http://www.postgresql.org/docs/admin/ports.htm">
    http://www.postgresql.org/docs/admin/ports.htm</ulink>
    puede encontrar información actualizada sobre las plataformas soportadas. En general,
    la mayoría de la plataformas compatibles con Unix que utilicen bibliotecas actualizadas
    debería ser capaz de ejecutar <ProductName>PostgreSQL</ProductName>. 
    En el subdirectorio <filename>doc</filename> de la distribución existen varios documentos
    del tipo LEAME y otros con Preguntas de Uso Frecuente (FAQ en inglés) específicos
    para esa distribución, que pueden resultarle útiles si está teniendo problemas.
   </para>

   <para>
    La cantidad mínim de memoria que se requiere para ejecutar
    <ProductName>PostgreSQL</ProductName> es de sólo 8 MB. Sin embargo, se verifica una
    notable mejora en la velocidad cuando ésta se expante a 96 MB o más. La regla es que,
    por más memoria que usted instale en su sistema, nunca será demasiada.
   </para>
   <Para>
    Verifique que esista suficiente espacio libre en el disco. Necestará alrededor de 
    30 MB para los archivos con el código fuente durante la compilación, y unos 5 MB
    para el directorio de instalación. Una base de datos vacía ocupa aproximadamente 1 MB.
    De no estar vacía, la base ocupará unas cinco veces el espacio que ocuparía un
    archivo de texto que contuviera los mismos datos.Si ejecuta las pruebas de regresión, 
    necestiará alrededor de 20 MB extra como espacio temporal.
   </Para>

   <Para>
    Para revisar el espacio libre en el disco, utilice:
<programlisting>
$ df -k
</programlisting>
   </para>

   <para>
    Dados los precios actuales de los discos duros, debería considerar consegui uno grande
    y rápido antes de poner a trabajar una base de datos.
   </para>
  </Sect1>

<Sect1>
<Title>Procedimiento de Instalación</Title>

<Procedure>
<Title>Instalación de <ProductName>PostgreSQL</ProductName></Title>

<Para>
Para una instalación de nuevas, o una actualización desde una versión previa de
<ProductName>PostgreSQL</ProductName>:
</Para>

<Step Performance="optional">
<Para>
Cree la cuenta de superusuario <ProductName>PostgreSQL</ProductName>.
Éste es el usuario bajo el que corre el servidor. Para el uso en producción, 
deberá usted crear una cuenta de usuario diferente, sin privilegios (habitualmente
se utiliza (<literal>postgres</literal>). Si no tiene usted acceso como root, 
o quiere evitarse este paso, su propia cuenta de usuario es suficiente.
</para>
<para>
Ejecutar <ProductName>PostgreSQL</ProductName> como <literal>root</literal>, <literal>bin</literal>,
o cualquier otra cuenta con permisos de acceso especiales es un riesto de seguridad,
y por ello está permitido.
</para>
<Para>
No necesitará usted compilar e instalar bajo esta cuenta (aunque puede hacerlo).
Se le dirá cuando necesite conectarse como el superusuario de la base de datos.
</Para>
</Step>

<Step Performance="required">
<Para>
Si no está usted actualizando un sistema existente, salte a
<xref linkend="continue">.
</Para>

<Para>
Ahora necesitará usted realizar una copia de seguridad (backup) de su base de 
datos existente. Si tiene una instalación razonablemente reciente de su 
base de datos (posterior a la 6.0), conseguirá un vaciado de la misma tecleando:
<programlisting>
$ pg_dumpall > db.out
</programlisting>
     Si quiere usted conservar las identificación de los objetos (oids), utilice
     la opción -o al ejecutar <application>pg_dumpall</application>.
     Sin embargo, a no ser que tenga usted una razón especial para hacer esto, como
     podría ser utilizar estos identificadores como claves en las tablas, no 
     lo haga.
</Para>

<Para>
Asegurese de utilizar el comando <application>pg_dumpall</application>
de la versión que está usted ejecutando actualemente. Pero no utilice
el script de 6.0 o el superusuario <Productname>PostgreSQL</Productname>
tomará la propiedad de <Emphasis>todo</Emphasis>. Si es esta la versión 
que tiene usted, debería usted utilizar el comando 
<application>pg_dumpall</application> de una versión 6.x.x posterior.
El correspondiente a la versión 7.0 no trabajará en bases de datos anteriores.
Si está usted actualizando desde una versión previa a 
<ProductName>Postgres95</ProductName> v1.09, deberá usted realizar un backup de
su base de datos, instalar <ProductName>Postgres95</ProductName> v1.09, 
restaurar su base de datos, y realizar el backup de nuevo.
</Para>

<caution>
<Para>
     Debe usted asegurarse de que su base de datos no se actualiza durante 
     su backup. Si es necesario, pare el postmaster, edite los permisos del
     fichero <filename>/usr/local/pgsql/data/pg_hba.conf</filename> para 
     permitirle a usted sólo su uso, y relance de nuevo <application>postmaster</application>.
</Para>
</caution>
</Step>

<Step Performance="required">
<Para>
Si está usted actualizando un sistema existente, mate ahora el servidor de la
base de datos. Teclee:
<ProgramListing>
$ ps ax | grep postmaster
</ProgramListing>
Esto debería listar los números de proceso para una serie de procesos,
de un modo similar a:
<ProgramListing>
  263  ?  SW   0:00 (postmaster)
  777  p1 S    0:00 grep postmaster
</ProgramListing>
Teclee la siguiente línea, reemplazando <replaceable>pid</replaceable>
con el identificador (id) del proceso <literal>postmaster</literal>
(263 en el caso anterior). (No utilice el id del proceso "grep postmaster".)
(N. del T. también puede hacerlo con la línea 
<ProgramListing>
$ ps ax | grep postmaster |grep -v grep
</ProgramListing>
que le dará la misma salida, pero sin incluir la línea correspondiente al mismo
proceso "grep". Fin de la N. del T.)
<programlisting>
$ kill <replaceable>pid</replaceable>
</programlisting>
</Para>

<tip>
<para>
En sistemas que arrancan <productname>PostgreSQL</productname> en el durante la secuencia
de arranque de la máquina, probáblemente se encontrara un fichero startup que cumplirá el
mismo cometido. Por ejemplo, en un sistema Linux RedHat, se debería encontrar que
<programlisting>
$ /etc/rc.d/init.d/postgres.init stop
</programlisting>
funcione correctamente para parar la base.
</para>
</tip>

<Para>
También deberá trasladar los directorios anteriores a otro sitio. Teclee lo siguiente:
<programlisting>
$ mv /usr/local/pgsql /usr/local/pgsql.old
</programlisting>
con sus propias rutas particulares.
</Para>

</Step>

<Step Performance="required" id="continue">
<Para>
Configure el código fuente para su sistema. Este es el paso en el que puede usted
especificar su ruta de instalación actual para el proceso de construcción, y hacer
elecciones sobre lo que tenga usted instalado. Cambiese al subdirectorio
<filename>src</filename> y teclee:
<ProgramListing>
$ ./configure
</ProgramListing>
seguido de todas las opciones que desee usted dar. Para una primera instalación,
debería ir todo bien sin dar ninguna.
Para obtener una lista completa de las opciones, teclee:
<ProgramListing>
./configure --help
</ProgramListing>
     Algunas de las opciones que se utilizan más a menudo son:
<VariableList>
 <varlistentry>
  <term>--prefix=BASEDIR</term>
  <listitem>
   <para>
    Selecciona un directorio base diferente para la instalación de
    <ProductName>PostgreSQL</ProductName>. La opción de defecto es
    <filename>/usr/local/pgsql</filename>.
   </para>
  </listitem>
 </varlistentry>

 <varlistentry>
  <term>--enable-locale</term>
  <listitem>
   <para>
    Si quiere usted utilizar locales.
   </para>
  </listitem>
 </varlistentry>

 <varlistentry>
  <term>--enable-multibyte</term>
  <listitem>
   <para>
    Le permitirá utilizar páginas de caracteres multibyte. Se emplea 
    principalmente para lenguajes como japonés, coreano o chino.
   </para>
  </listitem>
 </varlistentry>

 <varlistentry>
  <term>--with-perl</term>
  <listitem>
   <para>
    Construye la interface Perl. Note por favor que la interface Perl se instalará
    en el lugar habitual de los módulos Perl (habitualmente bajo
    <filename>/usr/lib/perl</filename>), de modo que deberá usted tener acceso root
    para realizar esta opción correctamente.
   </para>
  </listitem>
 </varlistentry>

 <varlistentry>
  <term>--with-odbc</term>
  <listitem>
   <para>
    Construye el paquete del driver ODBC.
   </para>
  </listitem>
 </varlistentry>

 <varlistentry>
  <term>--with-tcl</term>
  <listitem>
   <para>
    Construye las librerías de interface y los programas que
    requieren Tcl/Tk, incluyendo libpgtcl, pgtclsh y pgtksh.
   </para>
  </listitem>
 </varlistentry>
</VariableList>

</Para>
</step>

<Step Performance="required">
<Para>
Compile el programa.  Teclee:
<ProgramListing>
$ gmake
</ProgramListing>
El proceso de compilación ocupará entre 10 minutos y una hora, variando 
en función de la máquina y de las opciones elegidas.
</Para>

<Para>
La última línea que se muestre por el proceso debería ser:
<programlisting>
All of PostgreSQL is successfully made. Ready to install.
</programlisting>
Recuerde que <Quote>gmake</Quote> se puede llamar <Quote>make</Quote>
en su sistema.
</Para>
</Step>

<Step Performance="required">
<Para>
Instale el programa.  Teclee:
<ProgramListing>
$ gmake install
</ProgramListing>
</Para>
</Step>

<Step Performance="required">
<Para>
Dígale a su sistema como encontrar las nuevas librerías compartidas. Cómo hacer esto 
varía de unas plataformas a otras.  Lo que tiende a trabajar en todas partes es fijar
la variable de entorno <envar>LD_LIBRARY_PATH</envar>:
<programlisting>
$ LD_LIBRARY_PATH=/usr/local/pgsql/lib
$ export LD_LIBRARY_PATH
</programlisting>
Quizá quiera usted poner estas dos líneas en un script de arranque de su shell, como 
<filename>~/.bash_profile</filename>.
</Para>

<Para>
En algunos sistemas se prefiere el siguiente método, pero debe usted tener acceso root.
Edite el fichero <filename>/etc/ld.so.conf</filename> y añada una línea
<programlisting>
<FileName>/usr/local/pgsql/lib</FileName>
</programlisting>
Y ahora corra el comando <Command>/sbin/ldconfig</Command>.
</Para>

<Para>
En la duda, diríjase a las páginas de manual de su sistema. Si recibe usted más tarde
un mensaje como 
<programlisting>
./psql: error in loading shared libraries
libpq.so.2.1: cannot open shared object file: No such file or directory
</programlisting>
entonces es que todo lo anterior era necesario.  Símplemente realice este paso de nuevo.
</Para>
</Step>

<Step Performance="required">
<Para>
Cree la instalación de la base de datos. Para hacer esto, debe usted conectarse como 
su cuenta de superusuario de <ProductName>PostgreSQL</ProductName>.
No trabajará como root.
<ProgramListing>
$ mkdir /usr/local/pgsql/data
$ chown postgres /usr/local/pgsql/data
$ su - postgres
$ /usr/local/pgsql/initdb -D /usr/local/pgsql/data
</ProgramListing>
</Para>
<Para>
La opción <option>-D</option> especifica la situación donde se almacenarán los datos.
Puede usted utilizar cualquier otro path, porque no tiene porqué estar bajo el 
directorio de la instalación. Sólo asegúrese de que la cuenta del superusuario 
puede escribir en el directorio (o crearlo) antes de arrancar <command>initdb</command>.
(Si estaba usted siguiendo los pasos de la instalación hasta ahora como el superusuario
de <productname>PostgreSQL</productname>, puede que tenga usted que conectarse como
root temporalmente para crear el directorio de datos.)
</Para>
</Step>

<Step Performance="required">
<Para>
Los pasos previos deberían haberle indicado como arrancar el servidor de la base de datos.
Ahagamos ahora:
<programlisting>
$ /usr/local/pgsql/bin/postmaster -D /usr/local/pgsql/data
</programlisting>
Esto arrancará el servidor en primer término. Para mandarlo a segundo plano, utilice
la opción <option>-S</option>.
</Para>
</Step>

<Step Performance="optional">
<para>
Si está usted actualizando desde una instalación anterior, extraiga sus datos con:
<programlisting>
$ /usr/local/pgsql/bin/psql < db.out
</programlisting>
Y haga también una copia de seguridad de su anterior fichero <filename>pg_hba.conf</filename>,
así como de todos los demás ficheros que pueda usted haber creado para la autenticación, 
tales como ficheros de claves de acceso.
</Para>
</Step>
</Procedure>

<para>
Con todo esto concluímos la instalación propiamente dicha. Para hacer su vida más 
productiva y agradable, debería mirar los siguientes pasos y sugerencias opcionales.
</para>

<itemizedlist>
<listitem>
<Para>
La vida será más conveniente si fija usted algunas variables de entorno. Primero, 
probablemente quiera usted incluir <filename>/usr/local/pgsql/bin</filename> (o su equivalente)
en su <envar>PATH</envar>. Para hacer esto, añada lo siguiente en su fichero de arranque
de la shell, tal como <filename>~/.bash_profile</filename> (o <filename>/etc/profile</filename>,
si quiere usted que afecte a todos los usuarios):
<programlisting>
PATH=$PATH:/usr/local/pgsql/bin
</programlisting>
</Para>
<Para>
Aún más, si usted fija la variable <envar>PGDATA</envar> en el entorno 
del superusuario de <ProductName>PostgreSQL</ProductName>, podrá usted omitir la 
opción <option>-D</option> para <filename>postmaster</filename> y <filename>initdb</filename>.
</Para>
</listitem>

<listitem>
<Para>
Probáblemente quiera usted instalar la documentación <application>man</application> y
<acronym>HTML</acronym>. Teclee
<ProgramListing>
$ cd /usr/src/pgsql/postgresql-7.0/doc
$ gmake install
</ProgramListing>
Esto instalará ficheros bajo <filename>/usr/local/pgsql/doc</filename>
y <filename>/usr/local/pgsql/man</filename>. Para permitir a su sistema encontrar
la documentación <application>man</application>, necesitará añadir una línea como 
la siguiente en el fichero de arranque de la shell:
<ProgramListing>
MANPATH=$MANPATH:/usr/local/pgsql/man
</ProgramListing>
</para>

<para>
La documentación está también disponible en formato Postscript. Si tiene 
usted una impresora Postscript, o tiene su impresora ya preparada para 
aceptar ficheros Postscript utilizando un filtro de impresión, podrá imprimir
la Guía de Usuario simplemente tecleando
<programlisting>
$ cd /usr/local/pgsql/doc
$ gunzip -c user.ps.tz | lpr
</programlisting>
Aquí tiene lo que debería hacer usted si tiene Ghostscript en su sistema y 
está escribiendo en una impresora lasejet:
<programlisting>
$ alias gshp='gs -sDEVICE=laserjet -r300 -dNOPAUSE'
$ export GS_LIB=/usr/share/ghostscript:/usr/share/ghostscript/fonts
$ gunzip user.ps.gz
$ gshp -sOUTPUTFILE=user.hp user.ps
$ gzip user.ps
$ lpr -l -s -r manpage.hp
</programlisting>
En caso de dudas, refierase a sus manuales o a su experto local.
</para>

<para>
Probáblemente debería empezar por leer la Guía del Administrador si es 
usted completamente nuevo en <productname>PostgreSQL</productname>, 
porque contiene información sobre como declarar usuarios y la autenticación 
a la base de datos.
</para>
</listitem>

<listitem>
<Para>
Habitualmente, querrá usted modificar su computadora de modo que arranque
el servidor de base de datos siempre que se ponga en marcha.
Esto no es necesario; el servidor <ProductName>PostgreSQL</ProductName> se 
puede ejecutar normalmente desde cuentas no privilegiadas sin intervención de root.
</para>
<para>
Diferentes sistemas tienen diferentes convenciones para arrancar demonios en el 
momento de la puesta en marcha, de modo que deberá usted familiarizarse primer con ellos.
La mayoría de los sitemas tienen un fichero <filename>/etc/rc.local</filename> o
<filename>/etc/rc.d/rc.local</filename> que en la mayoría de los casos no es un mal
lugar para situar este comando.
Siempre que lo haga, el postmaster deberá ser ejecutado por el superusuario de 
<ProductName>PostgreSQL</ProductName> (<literal>postgres</literal>) 
<emphasis>y no por root</emphasis> o cualquier otro usuario. Por ello, probáblemente
quiera usted formar las líneas de comando iniciandolas con
<literal>su -c '...' postgres</literal>.
</para>
<para>
Podría ser interesante mantener un registro de las salidas del servidor. Para arrancar
de esta forma el servidor, intente:
<ProgramListing>
nohup su -c 'postmaster -D /usr/local/pgsql/data > server.log 2>&1' postgres &
</ProgramListing>
</para>

<para>
Aquí tenemos algunas otras sugerencias específicas del sistema operativo:

<itemizedlist>
<listitem>
<para>
Edite el fichero rc.local en NetBSD o el fichero rc2.d en SPARC Solaris
          2.5.1 para que contenga la siguiente línea:
<programlisting>
su postgres -c "/usr/local/pgsql/bin/postmaster -S -D /usr/local/pgsql/data"
</programlisting>
</para>
</listitem>

<listitem>
<para>
En FreeBSD RELEASE-2.2 editE /usr/local/etc/rc.d/pgsql.sh para
          que contenga las siguientes líneas y hégale chmod 755 y 
          chown root:bin.

<programlisting>
#!/bin/sh
[ -x /usr/local/pgsql/bin/postmaster ] && {
    su -l pgsql -c 'exec /usr/local/pgsql/bin/postmaster
        -D/usr/local/pgsql/data
        -S -o -F > /usr/local/pgsql/errlog' &
    echo -n ' pgsql'
}
</programlisting>

          Usted puede colocar las rupturas de líneas como se muestra antes.
          La shell es capaz de seguir traduciendo más allá del final de la 
          línea si no se ha terminado una expresión. El exec salva un nivel 
          de shell bajo el proceso postmaster, de modo que el padre es init.
</para>
</listitem>

<listitem>
<para>
En Linux RedHat, añada un fichero <filename>/etc/rc.d/init.d/postgres.init</filename>
que se basará en el ejemplo que se encuentra en <filename>contrib/linux/</filename>.
Y a continuación haga in link simbólico a este fichero desde
 <filename>/etc/rc.d/rc5.d/S98postgres.init</filename>.
</para>
</listitem>

</itemizedlist>

</Para>
</listitem>

<listitem>
<Para>
Ejecute los test de regresión. Los test de regresión son un conjunto de pruebas que
verifican que <ProductName>PostgreSQL</ProductName> corre en su máquina en la forma
en que los desarrolladores esperan que lo haga. Debería hacer esto definitivamente antes
de poner una servidor en uso en producción. El fichero 
<filename>/usr/src/pgsql/postgresql-7.0/src/test/regress/README</filename>
contiene instrucciones detalladas para correr e interpretar los tests de regresión.
</Para>
</listitem>

</itemizedlist>
</Sect1>

</Chapter>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:nil
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
sgml-parent-document:nil
sgml-default-dtd-file:"./reference.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:"/usr/lib/sgml/CATALOG"
sgml-local-ecat-files:nil
End:
-->
