<?xml version="1.0" encoding="iso-8859-1" ?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook V4.1.2//EN"
"http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd">

<article>

<articleinfo>

<title>El Mini-Cómo de Ultra-DMA en Linux</title>

<author>
<firstname>Brion Vibber, <ulink
url="mailto:brion@pobox.com"
>brion@pobox.com</ulink
></firstname>
</author>

<pubdate>v2.0, 7 de Agosto 1998</pubdate>

<abstract>

<para>
Este documento pretende explicar cómo usar los discos duros con interfaces
Ultra-DMA, también conocidas como Ultra-ATA y Ultra33, en Linux. La última
versión de este documento puede encontrarse en formato HTML en
<ulink
url="http://pobox.com/~brion/linux/Ultra-DMA.html"
>http://pobox.com/&#732;brion/linux/Ultra-DMA.html</ulink
>.
</para>

</abstract>

</articleinfo>

<sect1 id="main-intro">
<title>Introducción</title>

<para>
Este documento pretende explicar cómo usar los discos duros con interfaces
Ultra-DMA, también conocidas como Ultra-ATA y Ultra33, en Linux. A pesar 
de que en algunos casos no encierran dificultad, pueden hacerse algunas
modificaciones con el fin de aumentar las prestaciones. Además,
comprobará que, en ocasiones, el uso de estos dispositivos no es tan trivial.
</para>

<sect2 id="disclaimer">
<title>Renuncia de responsabilidad</title>

<para>
La información que contiene este documento es, hasta donde llega mi
conocimiento, correcta, por lo que debería funcionar. De todas maneras, 
a parte de la posible existencia de errores ortográficos, cabe la posibilidad
de que lo descrito en este documento no funcione en su sistema, debido a
algún tipo de incompatibilidad. Es por ello que le recomiendo que, antes de
comenzar a manipular su disco duro, <emphasis remap="bf">¡HAGA COPIAS DE SEGURIDAD DE TODO
AQUELLO QUE QUIERA GUARDAR!</emphasis> Si no acostumbra a hacerlas, esta es una buena
ocasión para comenzar.
</para>

</sect2>

<sect2 id="credits">
<title>Reconocimientos</title>

<para>
<ulink
url="mailto:giovanni@sudfr.com"
>Michel Aubry</ulink
> - Parche
UDMA para VIA en &lt;=2.0.33
y más información, Gran Parche Unificado de UDMA para 2.0.34+
</para>

<para>
<ulink
url="mailto:andrebalsa@altern.org"
>Andrew Balsa</ulink
> - Proveyó
información general sobre UDMA y el parche udma-generic para Intel TX,
SiS, y VP1 en &lt;=2.0.33; también Gran Parche Unificado de UDMA para
2.0.34+
</para>

<para>
Maxime Baudin - Traducción al Francés
</para>

<para>
Bokonon - ``Controladora'' vs. ``interfaz''
</para>

<para>
<ulink
url="mailto:prefect@ipass.net"
>John G.</ulink
> -
Parche para VIA VP2 en &lt;=2.0.33 e información
</para>

<para>
Martin Gaitan - Instalación de ide0/ide1 para Promise Ultra33
</para>

<para>
<ulink
url="mailto:hedrick@Astro.Dyer.Vanderbilt.Edu"
>Andre M. Hedrick</ulink
> -
Gran Parche Unificado de UDMA para 2.0.34, Artop ATP850UF
</para>

<para>
Norman Jacobowitz - Me pidió añadir información sobre VP3
</para>

<para>
John Levon - Información sobre la TX Pro mobos
</para>

<para>
Peter Monta - Información sobre el uso de dos tarjetas Ultra33
</para>

<para>
Masayoshi Nakano - Traducción al Japonés
</para>

<para>
<ulink
url="mailto:gadio@netvision.net.il"
>Gadi Oxman</ulink
> - El parche
de la Promise Ultra33 para &lt;=2.0.34 y números secretos
para el truco
</para>

<para>
Andy Pearce - Sugirió añadir información de los ficheros de dispositivo
adicionales para hde-h
</para>

<para>
<ulink
url="mailto:pink@roedu.net"
>Andrei Pitis</ulink
> - Parche para LILO
</para>

<para>
<ulink
url="mailto:brion@pobox.com"
>Brion Vibber</ulink
> - Este documento
</para>

</sect2>

<sect2 id="history">
<title>Historia del Documento</title>

<para>
v2.0, 7 Agosto 1998: actualización y total reestructuración de la
información sobre interfaces de la placa madre y tarjetas externas,
información sobre el Gran Parche Unificado de UDMA (una parte del parche
Jumbo) para 2.0.35, créditos en orden alfabético por el apellido, sustitución
del término ``controladora'' por ``interfaz'' (más correcto desde
el punto de vista técnico), nueva información sobre activación/desactivación
de UDMA, añadida una lista de problemas ¡y más cosas!
</para>

<para>
v1.45, 6 Julio 1998: pequeñas actualizaciones, parche de la Promise Ultra33
para el núcleo 2.0.34 en la Red Hat 5.1 y parche que permite a LILO
arrancar desde interfaces PCI como la Promise Ultra33.
</para>

<para>
v1.41, 3 Mayo 1998: arreglados unos cuantos errores ortográficos y presencia
de los traductores en los créditos.
</para>

<para>
v1.4, 28 Abril 1998: parche UDMA-Generic, nueva información general y
aparición de una sección sobre copias.
</para>

<para>
v1.3, 5 Marzo 1998: información sobre VIA VP3, mejores instrucciones de
``parcheado'' y enlace al parche de Promise más reciente.
</para>

<para>
v1.2, 27 Enero 1998: información adicional del truco para la Promise.
</para>

<para>
v1.1, 21 Enero 1998: nueva información acerca del chipset VIA, instalación
de la Promise Ultra33 y activación de los modos de transferencia Bus Master y
UDMA.
</para>

<para>
v1.0, 19 Enero 1998: primera versión escrita en SGML. Bastante completa.
</para>

</sect2>

<sect2 id="copying">
<title>Copias</title>

<para>
Este documento puede ser copiado libremente y/o distribuido para propósitos
informativos. No puede ser modificado, excepto para cambio de formato,
sin la autorización del autor. Si desea traducir este documento a otro
idioma lo puede hacer pero, de todas formas, deberá contactar primero con
el autor para que las versiones actualizadas puedan ser enviadas a los
traductores, así como al Linux Documentation Project.
</para>

</sect2>

</sect1>

<sect1 id="udma-intro">
<title>¿Qué es Ultra-DMA y para qué lo quiero?</title>

<para>
Aquí tiene una breve descripción de las tecnologías de dispositivos
basadas en IDE:
</para>

<sect2 id="classic">
<title>IDE, EIDE, y ATAPI</title>

<para>
Estas son tecnologías antiguas. La mayoría de los discos duros e interfaces de
disco que puede comprar, o que posiblemente ya esté usando, son de tipo EIDE.
No obstante, abundan cada vez más aquellos discos duros que cuentan con una
interfaz UDMA.
</para>

</sect2>

<sect2 id="bm">
<title>Bus Master DMA</title>

<para>
El Bus Master DMA es una tecnología para incrementar la velocidad de las
transferencias de datos en los discos duros. Dicha tecnología requiere
soporte de la placa madre y la BIOS, y algún soporte adicional por parte
del disco.
</para>

<para>
Puede aprender más sobre el tema en <ulink
url="http://developer.intel.com/design/pcisets/busmastr/FAQs.htm"
>http://developer.intel.com/design/pcisets/busmastr/FAQs.htm</ulink
>.
</para>

</sect2>

<sect2 id="udma">
<title>Ultra-DMA o Ultra-ATA o Ultra33 o...</title>

<para>
El Ultra-DMA tiene muchos nombres, pero nosotros lo denotaremos aquí
por UDMA.
</para>

<para>
UDMA es una tecnología más avanzada y que provee unas transferencias
mucho más rápidas (hasta 33.3 MB/s) que la EIDE, siendo su precio
más reducido que el los dispositivos SCSI. Muchos de los nuevos ordenadores
incorporan grandes discos e interfaces UDMA. Además, es posible añadir una
tarjeta de interfaz UDMA (como la Promise Ultra33) a un sistema ya existente,
pudiendo aumentar la velocidad de transferencia de sus discos duros incluso
si estos no son UDMA.
</para>

<para>
Puede aprender más detalles sobre UDMA en
<ulink
url="http://www.quantum.com/src/whitepapers/ultraata/"
>http://www.quantum.com/src/whitepapers/ultraata/</ulink
>
</para>

<para>
Nótese que la longitud de cable para la conexión del UDMA debe ser menor
que la de un cable para DMA normal. Lo ideal es que esté por debajo de los
30 cm (12&quot;).
</para>

</sect2>

<sect2 id="speed">
<title>¿Exactamente cómo de ``Ultra'' es?</title>

<para>
Antes de ir más lejos, aclaremos una equivocación. Los 33 MB/seg son la
<emphasis remap="bf">tasa de transferencia instantánea</emphasis> (burst transfer rate), y es algo
que no verá muy frecuentemente. Para explicarlo, aquí hay un pequeño texto
del UDMA.txt (udma-generic):
</para>

<para>

<screen>
Las tasas de transferencia instantánea se supone que van
desde los 16,6MB/s (modo PIO 4) a 16,6MB/s (DMA modo 2) hasta 33MB/s
(UDMA). En su parche contra el núcleo 2.1.55, Kim-Hoe Pang realmente
analizó las tasas de transferencia instantánea en UDMA con un analizador
lógico: 60ns/palabra, lo que se traslada a 33MB/s.

Nótese que las tasas de transferencia instantánea sólo afectan a las
transferencias de datos desde/hacia la caché del disco EIDE (476kB para
el disco de 6,4GB de IBM), y no son particularmente relevantes para la
mayoría de los usuarios de Linux.

El núcleo de Linux usa tanta memoria RAM como es posible para hacer de
caché en los accesos a los datos del disco duro, y si los datos no están
en la caché del núcleo, es improbable que estén en la caché del disco duro
(mucho más pequeña).
</screen>

</para>

<para>
Mucho más relevante es la <emphasis remap="bf">tasa de transferencia sostenida</emphasis> (sustained
transfer rate), que es la velocidad a la cual los datos pueden ser
transferidos desde el disco a la memoria principal, donde pueden usarse.
Una manera fácil de medir esta tasa es usar <literal remap="tt">hdparm</literal>, por ejemplo
``<literal remap="tt">hdparm -Tt /dev/hda</literal>'' para el primer dispositivo IDE.
</para>

<para>

<screen>
Aquí hay algunos datos recogidos después de pruebas muy extensas, usando
la utilidad hdparm (escrita por Mark Lord):

Tasas de transferencia bajo Linux con PIO modo 4:   +/- 5,2MB/s

Tasas de transferencia bajo Linux con DMA modo 2:   +/- 7,2MB/s

Tasas de transferencia bajo Linux con UDMA modo 2:  +/- 9,8MB/s

</screen>

</para>

<para>
Como puede comprobar, UDMA es todavía casi el doble de rápido que un EIDE
normal y significativamente más rápido que el bus mastering DMA normal.
</para>

</sect2>

<sect2 id="udma-vs-scsi">
<title>UDMA comparado con SCSI</title>

<para>
No tengo grandes números para ofrecerle, pero el consenso generalizado es
que el SCSI de alto nivel ofrece mejores prestaciones que el UDMA. De
todas formas, si ha echado un vistazo últimamente a los precios de los
discos duros, habrá notado que tienden a ser mucho más baratos. La
relación prestaciones/precio favorece al UDMA en la mayoría de los casos.
</para>

</sect2>

</sect1>

<sect1 id="udma-on-eide">
<title>Usando su disco duro UDMA con una interfaz EIDE</title>

<para>
Es fácil de hacer. Dado que todos los discos UDMA son completamente
compatibles con EIDE, sólo tiene que enchufar su disco UDMA de la misma forma
que sus antiguos discos, y Linux no debería tener ningún problema en
detectarlo y utilizarlo. De todas maneras, estará limitado, por supuesto,
a la menor velocidad del EIDE.
</para>

</sect1>

<sect1 id="using-udma">
<title>Usando sus discos duros con una interfaz UDMA</title>

<para>
Hay buenas y malas noticias. Las buenas noticias son que una interfaz UDMA
puede ser usado tanto con discos duros UDMA como con los antiguos EIDE,
y será mucho más rápido que una interfaz de este tipo.
</para>

<para>
Las malas noticias son que los núcleos actuales (como el 2.0.35) no
soportan la tecnología UDMA de una forma óptima, aunque existen ya algunos
parches para ellos. Por su parte, los núcleos en desarrollo (el actual es
el 2.1.114) disponen de un soporte más avanzado para UDMA.
Por desgracia, algunas tarjetas de expansión con interfaces UDMA necesitan,
o bien un parche, o algún tipo de truco para poder ser usadas. Es por eso que
este documento existe: para explicar cómo obtener estos parches y cómo
aplicar estos trucos.
</para>

</sect1>

<sect1 id="pci">
<title>Interfaces UDMA PCI externas</title>

<para>
Estas son interfaces UDMA sobre tarjetas PCI que pueden ser usadas para
añadir esta capacidad a un ordenador existente sin tener que reemplazar la
placa madre o para añadir soporte para cuatro dispositivos adicionales
a un ordenador que tiene ocupados todos los que ofrece su placa madre.
Pueden encontrarse preinstaladas en algunos ordenadores, especialmente
en máquinas Gateway 2000 y Dell.
</para>

<para>
Muchas de ellas no están soportadas por los núcleos estables actuales
(como el 2.0.35), debiendo aplicarse un parche o usar uno de los núcleos de
desarrollo (2.1.x). Si necesita instalar Linux en un disco duro conectado
a estas interfaces, necesitará usar algunos trucos.
</para>

<sect2 id="promise">
<title>Promise Ultra33</title>

<para>
Esta es una tarjeta PCI que tiene dos canales UDMA, soportando hasta
cuatro dispositivos en total. Puede ver las especificaciones y precios en
<ulink
url="http://www.promise.com"
>http://www.promise.com</ulink
>.
</para>

<para>
Esta tarjeta se incluía en los sistemas Pentium II modernos modelo
Gateway 2000, y puede aparecer o no en modelos más recientes.
</para>

<para>
El núcleo 2.0.35 soporta el Ultra33 explícitamente, y los núcleos en
desarrollo (el actual es el 2.1.114) dispone de soporte genérico para
interfaces IDE PCI que, automáticamente, detecta el Promise Ultra33. Pero,
los viejos núcleos estables (2.0.34 e inferiores) no lo detectan y,
dado que muchas de las distribuciones de Linux incluyen estos últimos,
puede ser bastante complicado instalar este sistema operativo.
</para>

<para>
<emphasis remap="bf">Instalando Linux con la Promise</emphasis>
</para>

<para>
Aunque hay un parche para la interfaz Promise, ¡no es fácil aplicarlo
y recompilar el núcleo si todavía no tiene Linux instalado! Por
eso, hay un truco que le permite instalarlo. Agradecimientos a Gadi Oxman
por la siguiente información sobre la obtención de la configuración de la
interfaz:
</para>

<para>

<screen>
Si podemos acceder a la consola con el disco de instalación, también
podemos usar "cat /proc/pci" para obtener la configuración de la interfaz:

    RAID bus interface: Promise Technology Unknown device (rev 1).
      Vendor id=105a. Device id=4d33.
      Medium devsel.  IRQ 12.  Master Capable.  Latency=32.
      I/O at 0xe000.   (a)
      I/O at 0xd804.   (b)
      I/O at 0xd400.   (c)
      I/O at 0xd004.   (d)
      I/O at 0xc800.   (e)

y pasar el parámetro "ide2=a,b+2 ide3=c,d+2" en la línea de argumentos
del núcleo.
</screen>

</para>

<para>
Nótese que los números probablemente no sean los mismos que los que usted
tendrá. Sólo como ejemplo, los parámetros a usar con el conjunto de
números anterior sería ``<literal remap="tt">ide2=0xe000,0xd806 ide3=0xd400,0xd006</literal>''.
Si sólo está usando el primer canal del Ultra33 (por ejemplo, si usted
sólo dispone de un dispositivo, o dos si son master y slave en el mismo
canal), entonces no necesitaría especificar <literal remap="tt">ide3</literal>.
</para>

<para>
<emphasis remap="bf">Red Hat 5.1:</emphasis> Inicie la instalación con el disquete de arranque,
pulsando ENTER cuando se le pregunte. El núcleo se cargará y entonces
se le preguntará por el idioma, tipo de teclado, y modo de instalación.
Se le pedirá información adicional sobre el medio de origen; no importa
lo que responda mientras llegue al siguiente paso. Entonces verá una
pantalla titulada ``Select Installation Path''; pulse Alt-F2 ahora para
llegar al intérprete de comandos. Ejecute ``<literal remap="tt">cat /proc/pci</literal>'',
apunte los números como antes, y vuelva a arrancar desde el mismo disquete.
Esta vez, escriba ``<literal remap="tt">linux ide2=</literal> <emphasis>(aquí es donde debe poner
los números como se mostró anteriormente)</emphasis><literal remap="tt"> ide3=</literal><emphasis>(más números)</emphasis>'' y
luego pulse ENTER. Ahora debería ser posible alojar Linux en su disco duro
sin dificultades, aunque LILO probablemente no será capaz de instalarse de
forma correcta: haga un disquete de arranque y utilícelo para acceder a
su sistema Linux con los mismos parámetros, hasta que pueda parchear el LILO
y el núcleo.
</para>

<para>
<emphasis remap="bf">Red Hat 5.0</emphasis> y <emphasis remap="bf">Slackware 3.4:</emphasis> El proceso a seguir en ambas
distribuciones es similar, incluyendo el problema de que los programas
de instalación ignoran los <literal remap="tt">/dev/hde-h</literal> (los dispositivos en
<literal remap="tt">ide2</literal> e <literal remap="tt">ide3</literal>). Para poder instalar a/o desde estos dispositivos
es necesario pasar por encima de uno o de los dos canales de interfaz
de la placa madre. De todas maneras, asegúrese de no pasar por encima de 
un dispositivo que necesite para la instalación; por ejemplo, si está 
instalando desde un CD-ROM en <literal remap="tt">/dev/hdd</literal> (<literal remap="tt">ide1</literal>, interfaz en 
la placa madre) a un disco duro en <literal remap="tt">/dev/hde</literal> (<literal remap="tt">ide2</literal>, 
el Ultra33), debería deshabilitar el innecesario <literal remap="tt">ide0</literal> con <literal remap="tt">ide2</literal>
y dejar intacto <literal remap="tt">ide1</literal>. Asumiendo los números anteriores, debería 
arrancar con ``<literal remap="tt">ide0=0xe000,0xd806</literal>''. Red Hat 5.0 le ofrecerá un 
intérprete de comandos si usa la capacidad de disquete de rescate 
(rescue disk), y Slackware incluye un intérprete en el proceso de
instalación normal. Tenga en cuenta que Red Hat 5.0 es difícil de arrancar
después de la instalación; si tiene problemas podría probar a bajarse un
disquete de arranque de Slackware desde <ulink
url="ftp://ftp.cdrom.com/pub/linux/slackware-3.5/bootdsks.144/"
>ftp://ftp.cdrom.com/pub/linux/slackware-3.5/bootdsks.144/</ulink
> y
usarlo para arrancar.
</para>

<para>
Con otras distribuciones de Linux deberá improvisar un poco, pero el
proceso debería ser el mismo que el visto anteriormente.
</para>

<para>
<emphasis remap="bf"><emphasis>IMPORTANTE:</emphasis></emphasis> ¡Sin el parche (del cual se habla en la
sección <xref linkend="generic"/>), el núcleo <emphasis remap="bf">necesita</emphasis>
estos parámetros de arranque para poder acceder a su disco duro! Por eso
es muy importante que cuando configure LILO, tanto en un disco duro como
en un disquete de arranque, añada los <emphasis remap="bf">mismos parámetros exactamente</emphasis>
tal y como lo hizo al instalar. ¡De otra manera su sistema no arrancará!
Debería ser posible pasárselos a LILO cuando arranque (por ejemplo,
pulsando MAYS, escribiendo ``<literal remap="tt">linux ide2=</literal><emphasis>.....</emphasis>'' cada vez que
lo haga), ¡pero sólo podrá hacerlo si guarda los números! Es recomendable
que aplique el parche al núcleo tan pronto como pueda para que no 
deba preocuparse al respecto; una vez que pueda arrancar con el 
núcleo parcheado, podrá olvidarse de los parámetros de arranque.
Además, por lo menos que yo sepa, no hay manera de pasar parámetros
a un disquete de arranque sencillo (hecho con ``<literal remap="tt">make zdisk</literal>''),
<emphasis remap="bf">deberá</emphasis> usar LILO u otro cargador (como LOADLIN) que le
permita pasarlos.
</para>

<para>
De todas maneras, los núcleos no parcheados y programas de instalación
pasan un mal rato usando ide2 e ide3, aunque los dispositivos hayan sido
detectados correctamente. Por eso, si no es capaz de instalar Linux usando
la técnica anterior, pruebe a especificar ide0 o ide1 en vez de ide2 o
ide3 (gracias a Martin Gaitan por esta técnica). Esencialmente consiste
en reemplazar el interfaz en placa por el Promise Ultra33, al menos
en lo que concierne al núcleo, pudiendo seguir en la dirección de la
siguiente sección como si los hubiera movido físicamente. Nótese que si
está usando el CD-ROM IDE conectado a su interfaz en placa como fuente de
la instalación, ¡deberá asegurarse que no deshabilita la interfaz en la
que se encuentra el CD o será incapaz de instalar! Si el CD está en hda o
hdb, use ide1 para su disco duro, y si está en hdc o hdd, entonces use
ide0.
</para>

<para>
<emphasis remap="bf">Instalando Linux saltándose la Promise</emphasis>
</para>

<para>
Si no consigue que funcionen los trucos software, tendrá que usar un
método más expeditivo. Este es un método alternativo que virtualmente
tiene éxito garantizado, pero va a requerir que abra su ordenador y lo
modifique internamente. <emphasis remap="bf">NOTA:</emphasis> ¡Si no está familiarizado con el
proceso de conectar y desconectar dispositivos IDE, <emphasis remap="bf">lea los manuales</emphasis>
que venían con su ordenador, su disco duro y/o con la Promise Ultra33
antes de intentarlo! Si modifica algo y no sabe cómo ponerlo otra vez en
su sitio, ¡podría acabar arrepintiéndose!
</para>

<para>
Habiendo dicho esto, es todo muy simple. Muchas de las placas madres de
hoy en día tienen incorporadas interfaces EIDE. Desconecte su disco duro
de la Ultra33 y conéctelo a la interfaz en placa. Si tiene otros
dispositivos IDE en la misma interfaz, como un CD-ROM, una unidad de cintas
o un disco ZIP, es más fácil si simplemente añade el disco duro en algún
canal no usado (el secundario en vez del primario) o temporalmente
desconecte algún dispositivo que no necesite inmediatamente (como el ZIP
o la cinta). Instale Linux y, finalmente, bájese y aplique el parche para
la Promise UDMA (vea la sección siguiente).
</para>

<para>
Ahora está en disposición de volver a poner el disco en la Promise...
casi. Para estar seguro haga un disquete de arranque (<literal remap="tt">cd
/usr/src/linux ; make zdisk</literal>) que podrá usar para arrancar su
sistema en caso de que LILO no funcione. Bueno, para estar <emphasis remap="bf">muy</emphasis>
seguro, haga dos y guarde uno de ellos por ahora.
</para>

<para>
Muy bien, ahora es el momento de pensar un poco... si sólo dispone de un
disco duro que se encontrará en la Promise, entonces lo más seguro es
que sea <literal remap="tt">/dev/hde</literal> (<literal remap="tt">a</literal> y <literal remap="tt">b</literal> son para la interfaz primaria
en placa, <literal remap="tt">c</literal> y <literal remap="tt">d</literal> para la secundaria). Si va a poner más
discos, entonces el esclavo del primer canal de la Promise será
<literal remap="tt">/dev/hdf</literal>, el master del segundo <literal remap="tt">/dev/hdg</literal> y el
esclavo del segundo <literal remap="tt">/dev/hdh</literal>.
</para>

<para>
Edite <literal remap="tt">/etc/fstab</literal>, y cambie todas las particiones de los discos
duros que está moviendo de los dispositivos en placa (<literal remap="tt">/dev/hda</literal>, 
<literal remap="tt">hdb</literal>, etc) a sus nuevas localizaciones en la Promise
(<literal remap="tt">/dev/hde</literal>, <literal remap="tt">hdf</literal>, etc). Si tiene que poner otros
dispositivos (como un CD-ROM o un disco ZIP) que desea dejar en la interfaz
en placa, entonces cámbielos a su nueva localización también. Por
ejemplo, si su CD-ROM era originariamente el master del canal primario
(<literal remap="tt">/dev/hda</literal>), pero puso su disco duro en ese lugar y
tuvo que cambiar el CD al esclavo (<literal remap="tt">/dev/hdb</literal>) o al canal
secundario (<literal remap="tt">/dev/hdc</literal>), y ahora quiere volver a ponerlo otra vez
en su sitio, entonces cámbielo a <literal remap="tt">/dev/hda</literal>.
</para>

<para>
Si está usando LILO, reconfigúrelo para usar la nueva localización del
dispositivo (la configuración de LILO sale de las pretensiones de este
documento, así que si no conoce cómo hacerlo, lea el 
<ulink
url="http://sunsite.unc.edu/LDP/HOWTO/mini/LILO.html"
>LILO mini-HOWTO</ulink
>),
o no será capaz, probablemente, de arrancar a menos que no use el
disquete de arranque que le he hecho hacer, con el que también deseará
arrancar la nueva partición. Esto se hace usando el comando <literal remap="tt">rdev</literal>:
introduzca el disquete y escriba ``<literal remap="tt">rdev /dev/fd0 /dev/hde1</literal>''.
Por supuesto, esto es suponiendo que su partición raíz es la primera de su
primer dispositivo UDMA. Si no es así (por ejemplo, en mi caso es
<literal remap="tt">/dev/hde7</literal>), entonces use el número de partición apropiado.
</para>

<para>
Vuelva a arrancar. Su sistema tendría que funcionar correctamente.
</para>

<para>
<emphasis remap="bf">Aplicando el parche para la Promise</emphasis>
</para>

<para>
El núcleo 2.0.35 y superior soporta de forma nativa la Promise Ultra33;
obtenga y actualícese desde su distribución Linux o desde <ulink
url="http://www.kernel.org"
>http://www.kernel.org</ulink
>.
</para>

<para>
Para instrucciones sobre cómo compilar el núcleo, lea el <ulink
url="ftp://ftp.insflug.org/es/Kernel-Como.gz"
>Kernel-COMO</ulink
>.   
</para>

<para>
<emphasis remap="bf">Usando dos tarjetas Ultra33 en el mismo ordenador</emphasis>
</para>

<para>
Esto actualmente no funciona correctamente... no lo haga por ahora a
menos que esté deseoso de modificar el núcleo para hacer que las cosas
funcionen.  
</para>

</sect2>

<sect2 id="artop">
<title>Artop ATP850UF</title>

<para>
Esta tarjeta está soportada por el udma-generic. La instalación de Linux
en un sistema con esta tarjeta como interfaz para el disco destino
debería ser similar al proceso para con la Promise Ultra33.
</para>

</sect2>

<sect2>
<title>Añadiendo ficheros de dispositivo</title>

<para>
Las interfaces IDE terciario y cuaternario (ide2 e ide3) usan ficheros de
dispositivo entre el <literal remap="tt">/dev/hde*</literal> y el <literal remap="tt">/dev/hdh*</literal>. En núcleos
antiguos estos dispositivos no eran creados automáticamente, por lo que
podría ser necesario añadirlos de forma manual para que las cosas
funcionen correctamente.
</para>

<para>
Esto se puede hacer fácilmente si tiene actualmente una copia instalada de
los fuentes del núcleo; simplemente ejecute <literal remap="tt">/usr/src/linux/scripts/MAKEDEV.ide</literal> 
y se crearán los ficheros de dispositivo relevantes.
</para>

</sect2>

</sect1>

<sect1 id="onboard">
<title>Interfaces UDMA en placa</title>

<para>
Estas son interfaces de dispositivo con capacidades UDMA incluidos dentro
de la placa madre. Utilizan los puertos de E/S estándares para IDE y por
ello son perfectamente operativos a velocidades lentas no-UDMA en
núcleos 2.0.x sin parchear, como los que se usan para instalar Linux. Por
ello, no deberían causar ningún problema durante la instalación, y
parchearlos para obtener la velocidad del UDMA es un lujo bien recibido
en vez de una necesidad.
</para>

<sect2 id="intel">
<title>Intel FX, HX, VX, TX, y LX</title>

<para>
Gracias otra vez a Gadi por esta información:
</para>

<para>

<screen>
El soporte para el DMA bus mastering en el chipset Intel TX está
disponible en el 2.0.31 y superior.
</screen>

</para>

<para>
En viejos núcleos (como el 2.0.30 de la Slackware 3.4), la interfaz será
usada en el modo EIDE lento.
En ambos casos, será automáticamente detectado por el núcleo y
no tendrá ningún problema para usarlo.
</para>

<para>
El soporte para usar el UDMA completo con estos chipsets se incluye en el
parche udma-generic; vea <xref linkend="generic"/>.
</para>

</sect2>

<sect2 id="via">
<title>El VIA VP2 y Chipsets relacionados</title>

<para>
Esta interfaz puede ser autodetectada y usada en modo EIDE por un núcleo 
sin parchear pero, si tiene uno de estos, querrá usar un parche para que
pueda obtener mayores tasas de transferencia y dejar en la cuneta esos
molestos mensajes "unknown PCI device" (dispositivo PCI desconocido).
</para>

<para>
Uno de ellos se puede obtener en
<ulink
url="http://www.ipass.net/~prefect"
>http://www.ipass.net/&#732;prefect/</ulink
>; está diseñado para el
chipset VIA VP2/97, que puede encontrarse en las placas madres de FIC
modelos PA-2007 y PA-2011, pero puede funcionar en chipsets relacionados.
Se ha informado que funciona con el chipset más moderno VIA VP3.
</para>

<para>
Nótese que este es un parche que sólo soporta el modo Bus Mastering, no
el modo UDMA completo, pero todavía es mejor que el modo EIDE normal.
Siga las instrucciones en el sitio Web del parche para activar el modo
BMDMA.
</para>

<para>
Hay otro parche que soporta el modo UDMA completo en
<ulink
url="http://www.pyreneesweb.com/Udma/udma.html"
>http://www.pyreneesweb.com/Udma/udma.html</ulink
>,
diseñado para el VIA VT82C586B y que debe funcionar para los chipsets VP2,
VP3, VPX, P6 y AGP Apollo. Siga las instrucciones para la instalación y
activación del modo UDMA, aunque es recomendable que haga una copia de
seguridad de todos los datos que desee guardar, ya que hay problemas
potenciales con placas madres incompatibles. Pero, si funciona, lo hará
sin problemas.
</para>

<para>
Nótese que el chipset VP1 no funciona con estos parches, aunque está
soportado por el parche <xref linkend="generic"/>.
</para>

</sect2>

<sect2>
<title>TX Pro y otras placas ``Pro''</title>

<para>
Actualmente el UDMA no está soportado para las placas madre TX Pro. Son
diferentes a las TX mobo, y aparentemente no informan correctamente de
sus capacidades de DMA, lo cual causa el problema. He oído que alguien
está trabajando en ello, por lo que podría aparecer un parche en el
futuro.
</para>

</sect2>

</sect1>

<sect1 id="generic">
<title>UDMA-Generic (UDMA genérico)</title>

<para>
El parche UDMA-Generic modificado por <ulink
url="mailto:andrebalsa@altern.org"
>André Balsa</ulink
>, <ulink
url="mailto:hedrick@Astro.Dyer.Vanderbilt.Edu"
>Andre Hedrick</ulink
> y <ulink
url="mailto:giovanni@sudfr.com"
>Michel Aubry</ulink
> a partir del driver de DMA de
la Triton de Mark Lord, da soporte UDMA a los siguientes chipsets (en su
versión 0.3):
</para>

<para>

<itemizedlist>
<listitem>

<para>
Todos los chipsets Intel: FX, HX, VX, TX, LX.
</para>
</listitem>
<listitem>

<para>
Todos los chipsets SiS (sólo probado el SiS5598, aunque toda la
familia tiene la misma interfaz de dispositivo 5513 integrado).
</para>
</listitem>
<listitem>

<para>
Chipsets VIA (sólo probado el 82C586B, pero otra vez esta familia
de chipsets tienen la misma estructura de interfaz). Para las
interfaces VIA existe soporte especial de diagnóstico.
</para>
</listitem>
<listitem>

<para>
Soporte para las tarjetas Promise y Artop PCI UDMA. No se ha
incluido todavía otras tarjetas PCI UDMA.
</para>
</listitem>

</itemizedlist>

</para>

<para>
Se ha diseñado para que sea fácilmente extensible para el soporte de
otros chipsets.
</para>

<para>
Udma-generic, también conocido como el Gran Parche Unificado de UDMA
(GUUP - Grand Unified UDMA Patch) se ha incluido en el parche Jumbo, el
cual incluye otras características útiles como la detección automática de
memoria por encima de los 64 MB y la detección de la velocidad de reloj
de la CPU. Puede obtener el parche Jumbo para el núcleo 2.0.35 en 
<ulink
url="http://www.altern.org/andrebalsa/linux/"
>http://www.altern.org/andrebalsa/linux/</ulink
>. Este parche también
puede aplicarse contra el 2.0.36pre1 y posiblemente contra los siguientes.
</para>

<para>
Aquí hay algunas notas del autor:
</para>

<para>

<screen>
Las prestaciones con dispositivos UDMA de IBM en una buena placa madre se
acercan a las máximas tasas de transferencia: aproximadamente 10 MB/s
(medido con hdparm -t -T).

El chipset Intel TX tiene una única FIFO para disco duro compartida entre
sus dos interfaces IDE, por lo que usar 2 dispositivos UDMA no
significará una gran mejora respecto a usar uno solo.
Por contra, el SiS5598 tiene dos interfaces completamente separados, cada
uno con su propia FIFO. Teóricamente, se pueden llegar a los 66MB/s de
tasa de transferencia en placas madre con el chip SiS5598, usando el
controlador md  y `data stripping' en los dos discos. El SiS5571 tiene la
misma arquitectura de interfaz, creo. No tengo los caminos de datos de
los chipsets VIA, por lo que no puedo decir nada al respecto.

El controlador de núcleo IDE (U)DMA de Linux por Mark Lord tiene un
tiempo de configuración muy pequeño (latencia para las transferencias de
datos). Es ideal para las transferencias frecuentes y de pocos datos
(como las de los servidores de noticias con Linux) y puede ser en algunos
casos superior a los correspondientes competidores SCSI.
</screen>

</para>

</sect1>

<sect1 id="activate">
<title>Activando y desactivando el UDMA</title>

<para>
Normalmente, el núcleo compatible con UDMA automáticamente activará
este soporte para los dispositivos e interfaces que lo admitan. De
todas maneras, desde el núcleo 2.1.113 se desactivan las transferencias
con DMA por defecto a menos que haya configurado su núcleo 
específicamente para automáticamente activarlo. Esto podría parecer un
error, pero algunos dispositivos e interfaces no funcionan de
forma adecuada con el DMA activado; vea la Lista Negra del UDMA más
adelante.
</para>

<sect2 id="bootparam">
<title>Usando los parámetros de arranque del núcleo</title>

<para>
En núcleos 2.1.113 y en adelante, puede activar el DMA para ambos
dispositivos de una interfaz IDE usando el parámetro del núcleo 
<literal remap="tt">ideX=dma</literal>, donde X es el número de la interfaz (el primero es el 0).
</para>

<para>
Los parámetros de arranque del núcleo pueden activarse mediante LILO,
LOADLIN o desde la mayoría de los programas de arranque de Linux. Para más
información vea el <ulink
url="http://sunsite.unc.edu/LDP/HOWTO/Bootdisk-HOWTO.html"
>Bootdisk HOWTO</ulink
>.
</para>

</sect2>

<sect2 id="hdparm">
<title>Usando hdparm</title>

<para>
<literal remap="tt">hdparm</literal> es un programa usado para modificar los parámetros de los
discos duros en Linux. Entre otras cosas puede usarlo para activar o
desactivar el UDMA para un dispositivo y comprobar su tasa de
transferencia sostenida.
</para>

<para>
La mayoría de las distribuciones de Linux incluyen <literal remap="tt">hdparm</literal>, pero
necesitará aplicar un parche para incluir el soporte UDMA. Puede obtener
<literal remap="tt">hdparm</literal> de <ulink
url="ftp://sunsite.unc.edu/pub/Linux/system/hardware/hdparm-3.3.tar.gz"
>ftp://sunsite.unc.edu/pub/Linux/system/hardware/hdparm-3.3.tar.gz</ulink
> 
y el parche de <ulink
url="http://pobox.com/~brion/linux/hdparm-3.3-udma.patch.gz"
>http://pobox.com/~brion/linux/hdparm-3.3-udma.patch.gz</ulink
>.
</para>

<para>
Compile e instale de esta manera:
</para>

<para>

<screen>
cd /usr/src
tar zxvf /tmp/download/hdparm-3.3.tar.gz
cd hdparm-3.3
gzip -cd /tmp/download/hdparm-3.3-udma.patch.gz | patch -p0
make
if [ -f /sbin/hdparm ]; then rm -f /sbin/hdparm ; fi
make install
cp /usr/local/sbin/hdparm /sbin/hdparm
</screen>

</para>

<para>
<emphasis remap="bf">Para activar el UDMA para un disco duro:</emphasis> <literal remap="tt">hdparm -d1 /dev/hda</literal>
</para>

<para>
<emphasis remap="bf">Para desactivar el UDMA de un disco duro:</emphasis> <literal remap="tt">hdparm -d0 /dev/hda</literal>
</para>

<para>
<emphasis remap="bf">Para medir la tasa de transferencia de un disco:</emphasis> <literal remap="tt">hdparm -Tt /dev/hda</literal>
</para>

<para>
<emphasis remap="bf">Para ver qué opciones están activadas para un disco:</emphasis> <literal remap="tt">hdparm /dev/hda</literal>
</para>

<para>
<emphasis remap="bf">Para ver más información de su disco:</emphasis> <literal remap="tt">hdparm -i
/dev/hda</literal>
</para>

<para>
Para información más detallada lea la página de manual (``<literal remap="tt">man 8 hdparm</literal>'').
</para>

</sect2>

</sect1>

<sect1>
<title>Problemas</title>

<sect2 id="blacklist">
<title>La Lista Negra del UDMA</title>

<para>
Los siguientes dispositivos están en la ``lista negra''. <emphasis remap="bf">No</emphasis> debe
usar el UDMA con ellos, ya que podría causar corrupción en los datos.
</para>

<para>

<itemizedlist>
<listitem>

<para>
Western Digital WDC AC22100H
</para>
</listitem>

</itemizedlist>

</para>

<para>
La parte de UDMA en el parche Jumbo-2.0.35-9 deshabilita automáticamente
el DMA para este dispositivo.
</para>

</sect2>

<sect2>
<title>¿Va usted demasiado deprisa?</title>

<para>
Si lo está haciendo, ¡cuidado! Aquí tiene un trozo de la documentación de
udma-generic:
</para>

<para>

<screen>
NO SE PASE EN LA VELOCIDAD DE RELOJ del bus PCI. 37'5MHz es la velocidad
máxima soportada por el bus PCI. Algunos (supuestamente compatibles)
dispositivos UDMA nunca alcanzarán los 37'5MHz, pero estará correcto a
33'3MHz.

En cualquier caso, NUNCA, NUNCA ponga el bus PCI a 41'5MHz.

La configuración RECOMENDADA para su seguridad es 33MHz.

</screen>

</para>

</sect2>

<sect2>
<title>¿Su BIOS está actualizada?</title>

<para>
Aquí tiene otro trozo de los documentos de udma-generic:
</para>

<para>

<screen>
El trabajo real que involucra el configurar los chips para las
transferencias de DMA se realiza en su mayor parte por la BIOS de cada
placa madre. Por supuesto, uno espera que la BIOS haya sido programada
correctamente...

Por ejemplo, las placas madres ASUS SP-97v con su BIOS original (Rev.
1.03) no funcionarían correctamente con el controlador modificado de Linux,
ni en el modo DMA 2 ni en los modos UDMA; funcionaría correctamente
usando el modo PIO 4 o bajo Windows 95 en cualquier modo. Obtuve la
última imagen de la BIOS (Rev. 1.06) de la Web de ASUS y la copié en la
EPROM de mi BIOS. Ha funcionado perfectamente desde entonces (a
velocidades de bus de 66MHz).

Lo que esto nos dice es que la BIOS configura el controlador de DMA con
parámetros de temporización específicos (ciclos de `active pulse' y
`recovery clock'). Mi revisión inicial de BIOS probablemente tenía mal
esos tiempos. Dado que el controlador de Windows 95 modifica estos
tiempos por sí mismo (no depende de la BIOS el configurar los parámetros
de temporización del controlador de disco), solo tenía problemas
inicialmente con el controlador de Linux, mientras que en Windows 95
funcionaba bien.

Por eso, deje que lo vuelva a repetir: este controlador de (U)DMA para
Linux depende de la BIOS para una correcta configuración. Si tiene problemas,
primero compruebe que tiene la última revisión de la BIOS para su placa madre.

[...]

Las nuevas revisiones de las BIOS pueden obtenerse desde el sitio Web del
fabricante de su placa madre. Escribir la nueva imagen de la BIOS es una
operación simple pero en la que uno debe seguir estrictamente los pasos
explicados en el manual de la placa.

Las últimas revisiones de las BIOS Award parecen ser estables con el
UDMA. Cualquiera con fecha de 1998 sería correcta.
</screen>

</para>

</sect2>

<sect2 id="help">
<title>¡Si todavía no puede hacer que funcione!</title>

<para>
Si nada de este documento parece ayudarle, o al menos no es suficiente
para hacer que su máquina funcione, su mejor apuesta consiste en escribir
un mensaje que describa sus dificultades exactamente, de qué tipo de
interfaz UDMA dispone, si está en la placa o es una tarjeta externa, si
su disco actual es UDMA o sólo EIDE, exactamente qué configuración de
dispositivos tiene, que versión (distribución y versión del núcleo a ser
posible) de Linux está usando, y mándelo al grupo de noticias 
<ulink
url="news:comp.os.linux.hardware"
>comp.os.linux.hardware</ulink
>.
Probablemente obtendrá una ayuda pronto.
</para>

</sect2>

</sect1>

<sect1 id="suggest">
<title>Si tiene alguna información sobre UDMA que no aparezca en este
documento... </title>

<para>
¡ Perfecto ! Si sabe algo que yo no sé, enviémelo
(<ulink
url="mailto:brion@pobox.com"
>brion@pobox.com</ulink
>):
lo añadiré y actualizaré pronto este documento.
</para>

</sect1>

</article>
