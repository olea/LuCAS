<?xml version="1.0" encoding="ISO-8859-1" ?>

<chapter id="pykota-configuracion">

<chapterinfo>
	<keywordset>
		<keyword>pykota</keyword>
		<keyword>configuración</keyword>
	</keywordset>
</chapterinfo>

<title>Configuración</title>

<sect1 id="pykota-configuracion-intro">
	<title>Introducción</title>

	<para>La configuración de PyKota se realiza en dos archivos:
	<filename>/etc/pykota/pykota.conf</filename> y <filename>/etc/pykota/pykotadmin.conf</filename>.
	Como dichos archivos son suficientemente explicativos, sólo se van a realizar
	una serie de apuntes sobre los mismos. Refiérase
	a los apéndices: <xref linkend="pykota-pykota-conf"/> y
	<xref linkend="pykota-pykotadmin-conf"/> para ver un ejemplo de
	configuración de PyKota.</para>

</sect1>

<sect1 id="pykota-configuracion-usuarios">
	<title>Usuarios de pykota</title>

	<para>PyKota hace uso de dos usuarios para el acceso al directorio <acronym>LDAP</acronym>:
	uno destinado a la lectura de la base de datos de cuotas de impresión y otro destinado
	a la administración de esta base de datos. El primer usuario sólo ha de tener
	permisos de lectura y el segundo de lectura/escritura en la base de datos.</para>

	<para>Los usuarios utilizados en esta documentación son:</para>

	<itemizedlist>
		<listitem>
			<para><emphasis>pykotauser:</emphasis> usuario de sólo lectura.</para>
		</listitem>
		<listitem>
			<para><emphasis>pykotaadmin:</emphasis> administrador de PyKota.</para>
		</listitem>
	</itemizedlist>

	<para>Puede hacer uso del siguiente <acronym>LDIF</acronym> para generar
	dichos usuarios en su sistema:</para>

<programlisting># Entry: cn=pykotauser,dc=gsr,dc=pt
dn:cn=pykotauser,dc=gsr,dc=pt
cn: pykotauser
objectClass: simpleSecurityObject
objectClass: organizationalRole
userPassword: {crypt}y1pYJeZPC49BY
description: Usuario de acceso como sólo lectura para PyKota

# Entry: cn=pykotaadmin,dc=gsr,dc=pt
dn:cn=pykotaadmin,dc=gsr,dc=pt
cn: pykotaadmin
objectClass: simpleSecurityObject
objectClass: organizationalRole
userPassword: {crypt}y1pYJeZPC49BY
description: Usuario de acceso como sólo lectura para PyKota</programlisting>

	<para>En el siguiente ejemplo se muestra como añadirlos al directorio <acronym>LDAP</acronym>.
	Se supone que el archivo <filename>usuarios-pykota.ldif</filename> contiene los datos
	<acronym>LDIF</acronym> anteriores:</para>

	<example id="pykota-configuracion-usuarios-ejemplo-1">
		<title>Añadiendo los usuarios relativos a PyKota en el directorio <acronym>LDAP</acronym></title>

<screen><prompt>$</prompt> <userinput>/usr/bin/ldapadd -x -D "cn=admin,dc=gsr,dc=pt" -W  -f usuarios-pykota.ldif</userinput>
<computeroutput>Enter LDAP Password:</computeroutput> <userinput>[Clave]</userinput>
<computeroutput>adding new entry "cn=pykotauser,dc=gsr,dc=pt"

adding new entry "cn=pykotaadmin,dc=gsr,dc=pt"</computeroutput></screen>
	</example>

	<para>El siguiente paso consiste en dar los permisos adecuados a los usuarios en el
	directorio <acronym>LDAP</acronym>. Para ello edite el archivo de configuración
	de OpenLDAP, <filename>/etc/ldap/slapd.conf</filename>, y añada las siguientes líneas
	en los atributos <emphasis>userPassword, sambaLMPassword,sambaNTPassword y *</emphasis>
	de las listas de control de acceso:</para>

<programlisting><![CDATA[by dn="cn=pykotaadmin,dc=gsr,dc=pt" write
by dn="cn=pykotauser,dc=gsr,dc=pt" read]]></programlisting>

	<para>Por último, para asegurarse de que los usuarios con los que se autentificará
	PyKota en el servidor OpenLDAP no tienen límites de peticiones de búsquedas, añada
	las siguientes líneas:</para>

<programlisting><![CDATA[# User Limits
limits dn="cn=pykotauser,dc=gsr,dc=pt" size.soft=-1 size.hard=soft
limits dn="cn=pykotaadmin,dc=gsr,dc=pt" size.soft=-1 size.hard=soft]]></programlisting>

	<note><para>En el <xref linkend="openldap-slapd.conf"/> tiene un archivo de
	configuración completo.</para></note>

</sect1>

<sect1 id="pykota-configuracion-repaso-conf">
	<title>Repaso sobre las principales opciones de configuración</title>

	<para>En esta sección se realizará un breve repaso sobre las opciones más importantes
	de configuración de PyKota.</para>

	<sect2 id="pykota-configuracion-repaso-conf1">
		<title>Opciones del archivo <filename>/etc/pykota/pykota.conf</filename></title>

		<para>Este es el archivo de configuración principal de PyKota. Posee una
		sección <emphasis>[global]</emphasis>, donde se configuran
		las opciones por defecto para todas las impresoras administradas por
		PyKota. Opcionalmente, pueden existir otras secciones
		(<emphasis>[nombreimpresora]</emphasis>), destinadas a personalizar la configuración
		de una impresora en concreto.</para>

		<para>Aquí sólo se tratará la sección global, por ser las demás secciones
		similares a esta y dependientes del sistema donde se instale PyKota.</para>

		<sect3 id="pykota-configuracion-repaso-conf13">
			<title>Datos de <acronym>LDAP</acronym></title>

			<para>Las siguientes opciones le indican a PyKota el <emphasis>backend</emphasis>
			que ha de utilizar y los datos relativos al mismo:</para>

<programlisting>storagebackend: ldapstorage
storageserver: ldap://gsr.pt:389
storagename: dc=gsr,dc=pt
storageuser: cn=pykotauser,dc=gsr,dc=pt
storageuserpw: ********</programlisting>

			<para>La base a partir de la cual se almacenarán los usuarios de PyKota en
			el directorio <acronym>LDAP</acronym>:</para>

<programlisting>userbase: ou=people,dc=gsr,dc=pt
userrdn: uid</programlisting>

			<para>La base a partir de la cual se almacenará el crédito que poseen
			los usuarios de PyKota:</para>

<programlisting>balancebase: ou=people,dc=gsr,dc=pt
balancerdn: uid</programlisting>

			<para>La base a partir de la cual se almacenarán los grupos de PyKota en
			el directorio <acronym>LDAP</acronym>:</para>

<programlisting>groupbase: ou=groups,dc=gsr,dc=pt
grouprdn:  cn</programlisting>

			<para>La base a partir de la cual se almacenarán los datos de las impresoras de PyKota en
			el directorio <acronym>LDAP</acronym>:</para>

<programlisting>printerbase: ou=printers,ou=pykota,dc=gsr,dc=pt
printerrdn: cn</programlisting>

			<para>La base a partir de la cual se almacenarán los trabajos de impresión,
			cuotas de usuario, cuotas de grupo y el último trabajo realizado, respectivamente:</para>

<programlisting>jobbase: ou=jobs,ou=pykota,dc=gsr,dc=pt
userquotabase: ou=uquotas,ou=pykota,dc=gsr,dc=pt
groupquotabase: ou=gquotas,ou=pykota,dc=gsr,dc=pt
lastjobbase: ou=lastjobs,ou=pykota,dc=gsr,dc=pt</programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf-newuser-newgroup">
			<title>Creación de usuarios/grupos</title>

			<para>Estas dos opciones informan a PyKota como se han de añadir los datos de los
			usuarios y grupos en el sistema. Se ha seleccionado la opción de añadir
			la información sobre la cuota de impresión a los usuarios/grupos ya existentes:</para>

<programlisting>newuser : attach(posixAccount, warn)
newgroup : attach(posixGroup, warn)</programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf-usermail">
			<title>Correo electrónico de los usuarios</title>

			<para>Esta opción indica cual es el atributo, dentro del directorio <acronym>LDAP</acronym>,
			que ha de buscar PyKota para obtener el correo electrónico de los usuarios:</para>

<programlisting>usermail : mail</programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf-memberuid">
			<title>Atributo que contiene la lista de miembros de un grupo</title>

			<para>Indique en esta variable el atributo que contiene la lista de miembros
			de un grupo determinado:</para>

<programlisting>groupmembers: memberUid</programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf-smtp">
			<title>Servidor <acronym>SMTP</acronym></title>

			<para>Servidor de correo utilizado para enviar correos:</para>

			<tip><para>Si desea integrar su servidor de correo con el sistema que se está
			configurando en esta documentación, le aconsejo que lea el documento
			<ulink url="http://guepardo.dyndns.org:8080/sergio-gonzalez/doc/08-postfix-ldap/html/">http://guepardo.dyndns.org:8080/sergio-gonzalez/doc/08-postfix-ldap/html/</ulink></para></tip>

<programlisting>smtpserver: localhost</programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf-mail-domain">
			<title>Dominio para los correos electrónicos</title>

			<para>Esta variable establece el dominio al cual se enviarán los correos
			electrónicos de los usuarios del sistema. Es decir, será el valor
			que se ponga detrás de la @ como se muestra a continuación:
			<emphasis>usuario@gsr.pt</emphasis>.</para>

<programlisting>maildomain: gsr.pt</programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf18">
			<title>Contado de páginas</title>

			<para>Pykota permite realizar el contado de las páginas que se han impreso de
			dos maneras: mediante hardware (dejándole el trabajo de contado a la impresora)
			o mediante software (haciendo uso de un contador de páginas propio).</para>

			<para>En esta documentación, por el tipo de impresoras utilizadas (impresoras
			virtuales), se ha elegido el contado de páginas mediante software:</para>

<programlisting>accounter: software(/usr/bin/pkpgcounter)</programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf-error">
			<title>Qué hacer ante un error del subsistema de contado de páginas</title>

			<para>Existen dos posibles comportamientos ante un error en la contabilidad
			de las páginas: <emphasis>continuar</emphasis> con la cola de trabajos pendientes, como si
			nada hubiese ocurrido o <emphasis>detener</emphasis> la cola de trabajos
			pendientes.</para>

			<para>La opción elegida es la segunda, se detendrá el sistema de impresión
			ante un fallo en la contabilidad de las páginas.</para>

<programlisting>onaccountererror: stop</programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf19">
			<title>Información sobre el administrador de PyKota</title>

			<para>Información sobre quien es y cual es la dirección de correo electrónico
			del administrador de PyKota:</para>

<programlisting>admin: Sergio González González
adminmail: root@localhost</programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf-mailto">
			<title>Envío de notificaciones</title>

			<para>Se le indica a PyKota que envíe, tanto al usuario como al administrador,
			notificaciones sobre el estado de la cuota de un usuario determinado:</para>

<programlisting>mailto: both</programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf-mensajes">
			<title>Texto de las notificaciones</title>

			<para>Por defecto, PyKota provee una serie de mensajes de ejemplo que
			se emplearán para el envío de correos electrónicos cuando las cuotas
			de los usuarios se hayan sobrepasado o hayan alcanzado un cierto límite.</para>

			<para>Puede personalizar estos mensajes, las siguientes líneas le muestran
			un ejemplo:</para>

<programlisting><![CDATA[# Poor man's warning message
# The warning message that is sent if the "poorman" value is reached
# Again this must appear in the global section
poorwarn: Su saldo en la cuota de impresión es bajo.
 Dentro de poco no podrá volver a imprimir.

# Soft limit reached warning message
# The warning message that is sent if the soft quota limit is reached
# May appear either globally or on a per-printer basis
softwarn: Ha alcanzado su límite blando en la cuota de impresión.
 Esto significa que podrá seguir imprimiendo algún tiempo,
 pero debería contactar con su administrador para comprar
 más cuota de impresión.

# Hard limit reached error message
# The error message that is sent if the hard quota limit is reached
# May appear either globally or on a per-printer basis
hardwarn: Ha alcanzado su límite duro en la cuota de impresión.
 Esto significa que no podrá volver a imprimir.
 Contacte con su administrador en <root@gsr.pt> tan
 pronto como le sea posible para solucionar el
 problema.]]></programlisting>
		</sect3>

		<sect3 id="pykota-configuracion-repaso-conf-enforcement">
			<title>¿Se permite a los usuarios sobrepasar la cuota de impresión?</title>

			<para>Esta variable controla si se permite o no a un usuario completar un
			trabajo, si durante la impresión del mismo, se termina su cuota de
			impresión.</para>

			<para>La opción <emphasis>strict</emphasis> no permite esta situación,
			por lo que alertará al usuario y no permitirá la impresión. Esta es la
			opción elegida.</para>

			<para>La opción <emphasis>laxist</emphasis> permite finalizar el trabajo
			de impresión, si durante el trascurso del mismo, se termina la cuota
			de impresión del usuario.</para>

<programlisting>enforcement: strict</programlisting>
		</sect3>

	</sect2>

	<sect2 id="pykota-configuracion-repaso-conf2">
		<title>Opciones del archivo <filename>/etc/pykota/pykotadmin.conf</filename></title>

		<para>En este archivo se configura el usuario que tendrá acceso de
		escritura en la base de datos de PyKota. En este caso se utilizará
		el usuario <emphasis>pykotaadmin</emphasis>, por lo que se configurará
		de la siguiente forma:</para>

<programlisting># Quota Storage administrator's name and password
storageadmin: cn=pykotaadmin,dc=gsr,dc=pt
storageadminpw: **********</programlisting>

		<important><para>Asegúrese de que el archivo <filename>/etc/pykota/pykotadmin.conf</filename>
		sólo puede ser leído por el usuario <emphasis>root</emphasis> y por el usuario
		con el que se ejecuta el sistema de impresión.</para></important>

	</sect2>
</sect1>

</chapter>

