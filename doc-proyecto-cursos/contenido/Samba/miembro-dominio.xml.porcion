<?xml version='1.0' encoding='iso-8859-15'?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.2//EN" "http://www.oasis-open.org/docbook/xml/4.2/docbookx.dtd">

<!--
%****Miembro de un dominio****
\porcion{Miembro de un dominio}
\autor{\CPP}
\colaborador{\LDP}
\revisor{}
\traductor{}
-->


  <section>
    <title>Capítulo 7. Pertenencia a un dominio</title>
    <section remap="h2">
      <title><anchor id="dbdoclet.id.domain_member"/>Pertenencia a un dominio</title>
      <para>
      </para>

      <section remap="h3">
        <title>Pertenencia a un dominio</title>
	      <para>
        <emphasis>JohnH.Terpstra</emphasis>
        Samba Team <literal>&lt;jht@samba.org&gt;</literal>
        </para>
      <para>
        <emphasis>JeremyAllison</emphasis>
	Samba Team <literal>&lt;jra@samba.org&gt;</literal>
        </para>
      <para>
        <emphasis>Gerald(Jerry)Carter</emphasis>
	Samba Team <literal>&lt;jerry@samba.org&gt;</literal>
        </para>
      <para>
        <emphasis>AndrewTridgell</emphasis>
	Samba Team <literal>&lt;tridge@samba.org&gt;</literal>
       </para>
      <para>
        <emphasis>JelmerR.Vernooij</emphasis>
	The Samba Team <literal>&lt;jelmer@samba.org&gt;</literal>
     </para>
     <para>
             <emphasis>GuentherDeschner</emphasis>
	LDAP updates
	SuSE <literal>&lt;gd@suse.de&gt;</literal>
        </para>
 
        <para>
La pertenencia a un dominio es un tema de gran importancia para los administradores de redes. Samba tiene que participar como elemento servidor en el contexto de seguridad de de un dominio local y tiene que poder proporcionar cuentas de máquinas de confianza o si no podría ofrecer una opción viable para muchos usuarios. 
        </para>
        <para>
En este capítulo encontraremos información sobre la pertenencia a un dominio, la correspondiente configuración de Samba y los prodedimientos de los clientes MSW para unirse al dominio. Esto es necesario para cubrir las grandes lagunas de información que existen al respecto.
        </para>

      </section>

    </section>
    <section remap="h2">
      <title><anchor id="dbdoclet.id.id2898264"/>Características y ventajas</title>
      <para>
 Las estaciones de trabajo y servidores MSW que pretenden participar en la seguridad del dominio necesitan ser miembros del mismo. Ls particiàción en la seguridad del dominio con frecuencia se denomina Single Sign On (o SSO para abreviar). Este capítulo describe el proceso que se tiene que seguir para que una estación de trabajo u otro servidor formmen parte de del contexto de seguridad de un dominio MSW. 

      </para>
      <para>
        <anchor id="dbdoclet.id.id2898305"/>
Samba-3 se puede unir como a un dominio estilo NT4 como miembro servidor, a un dominio MSW Active Directory como un servidor miembro nativo o a una red de Dominio Samba. La pertenencia a un dominio presenta diversas ventajas:
      </para>
      <para>
        <itemizedlist>
          <listitem>
            <para>
 <anchor id="dbdoclet.id.id2898330"/>
 Los usuarios de estaciones de trabajo MSW se benefician del registro en el dominio (SSO.).
            </para>

          </listitem>
          <listitem>
            <para>
 
 Los derechos de acceso y propiedad de los miembros del dominio se pueden definir en la base de datos SAM (Security Account Manager) del dominio. Funciona tanto con serviodores del dominio como con estaciones de trabajo pertenecientes al dominio.
            </para>

          </listitem>
          <listitem>
            <para>
 
 Sólo las versiones Profesionales de la estaciones de tabajo MSW NT4/200x/XP miembros del dominio pueden usar las características de conexión (logon).
            </para>

          </listitem>
          <listitem>
            <para>
 Las estaciones de trabajo pertenecientes al dominio se pueden controlar mejor mediante el uso de ficheros de políticas (NTConfig.POL) y perfiles.
            </para>

          </listitem>
          <listitem>
            <para>
 Mediante el uso de scripts de conexión los usuarios pueden tener una acceso transparente a la aplicaciones de red albergadas por los servidores.
            </para>

          </listitem>
          <listitem>
            <para>
 
 Los administradores de red consiguen mejorar la gestión de acceso de los usuarios ya que no necesitan mantener cuentas de usuario en cada estación cliente o servidor, salvo la base de datos central del dominio, que puede ser mediante bien mediante una base da datos SAM dominio NT4/Samba, un dominio NT4 Domain soportado por un directorio LDAP o mediante la infrestructura de un an Active Directory.
            </para>

          </listitem>
</itemizedlist>

      </para>

    </section>
    <section remap="h2">
      <title><anchor id="dbdoclet.id.machine_trust_accounts"/>MS Windows Workstation/Server Machine Trust Accounts</title>
      <para>
 <anchor id="dbdoclet.id.id2898416"/>
 Una cuenta de máquina de confianza es una cuenta que se utliza para validar una máquina cliente en lugar de a un usuario en un servidor controlador de dominio. En la terminología Windows esto se conoce como <emphasis>cuenta de máquina</emphasis>. El propósito de la cuenta de máquina es prevenir que un usuario no autorizado pueda obtener acceso a una estación de trabajo del dominio. 

      </para>
      <para>
Esta es una característica de seguridad para prevenir que una máquina no autorizada com el mismo nombr NetBIOS se una al dominio y obtenga acceso a las cuentas de usuario/grupo. Los clientes porfesionales NT/200x/XP utilizan las cuentas de máquina de confianza, sin embargo los clientes W9x/Me/XP Home no lo hacen. En consecuencia los clientes W9x/Me/XP Home nunca serán auténticos miembros del dominio ya que no poseen cuantas de máquina de confianza y por tanto no tienen una contraseña compartida con el controlador de dominio.
 
      </para>
      <para>
Un PDC NT4 almacena cada cuenta de confianza de maquina en el registro. Con la aparición de MSW 2000 surge Active Directory,el nuevo almacenamiento para las cuentas de confianza de máquinas, sin embargo almacena cada cuenta de maquina en dos partes de la siguiente forma:
      </para>
      <para>
        <itemizedlist>
          <listitem>
            <para>
 
 Una cuenta de seguridad del dominio, almacenada en la base de datos de usuarios definida en <filename>smb.conf</filename> en el parámetro <anchor id="dbdoclet.id.id2898469"/> passdb backend. La naturaleza de la información de la cuenta dependerá del tipo de almacenamiento elegido, smbpassd, tdbsam, ldapsam.
            </para>
            <para>
El viejo formato de estos datos es la base de datos <literal>smbpasswd</literal> que contiene id ID Unix para el login, el identificador de usuario Unix (UID) y las contraseñas LanMan y NT cifradas. También hay alguna otra información que por ahora no nos resulta relevante.
 
            </para>
            <para>
Los dos nuevos tipos de bases de datos se llaman ldapsam, y tdbsam. Ambas almacenan muchos más datos que el viejo fichero. La información extra permite implementar nuevos controles de cuentas de usuario.

            </para>

          </listitem>
          <listitem>
            <para>
 Una cuenta Unix asociada, normalmente almacenada en <filename>/etc/passwd</filename>. Se espera que pronto se pueda prescindir de de las cuentas de usuarios Unix.
 
            </para>

          </listitem>
</itemizedlist>
 
      </para>
      <para>
        <anchor id="dbdoclet.id.id2898542"/>
Hay tres formas de crear cuentas de usuario:
      </para>
      <para>
        <itemizedlist>
          <listitem>
            <para>
 
 De forma manual desde la línea de órdenes. Ambas cuentas, la cuenta Unix y la cuenta Samba se crea a mano.
            </para>

          </listitem>
          <listitem>
            <para>
 <anchor id="dbdoclet.id.id2898571"/>
 Utilizando la gesión del servidor MSW NT4, bien desde un servidor miembro del dominio o bien utilizandolas herramientas Nexus disponibles en la Web de MS. Esta herramienta se puede utilizar desde cualquier máquina MSW siempre que esté conectado con una cuenta de administrador.
            </para>

          </listitem>
          <listitem>
            <para>
 Creación al vuelo. La cuenta de muina de confianza la crea Samba cuando el miembro se une al dominio. Este es el método recomedado por motivos de seguridad. La cuenta unix correspondiente se puede crear automáticamente o manualmente.
            </para>

          </listitem>
</itemizedlist>

      </para>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2898601"/>Creación manual de las cuentas de máquina de confianza</title>
        <para>
El primer paso en la creación manual de las cuentas es la creación de la cuenta Unix en <filename>/etc/passwd</filename>. Lo podremos hacer utilizando useradd o una herramienta similar o usando <command>vipw</command>: 
        </para>
        <para>
          <anchor id="dbdoclet.id.id2898641"/><anchor id="dbdoclet.id.id2898650"/>
        </para>
        <screen>
<literal>root# </literal><emphasis role="bold"><literal>/usr/sbin/useradd -g machines -d /dev/null -c "machine nickname" \
   -s /bin/false machine_name$ </literal></emphasis>

<literal>root# </literal><emphasis role="bold"><literal>passwd -l machine_name$</literal></emphasis>
        </screen>
        <para>
        </para>
        <para>
En el ejemplo anterior suponemos que existe una grupo <emphasis>machines</emphasis> que se usa como grupo primario para las cuentas de máquina. En los siguientes ejemplos el grupo <emphasis>machines</emphasis> tiene un GID igual a 100.

        </para>
        <para>
El valor correspondiente en <filename>/etc/passwd</filename> contendrá el nombre de la máquina terminado en "$", sin contraseña, una shell nula y sin directorio personal. Por ejemplo una máquina llamada <literal>?doppy</literal> podría tener una entrada en /etc/passwd similar a:
 
        </para>
        <screen>
doppy$:x:505:100:
<emphasis><literal>machine_nickname</literal></emphasis>:/dev/null:/bin/false
        </screen>
        <para>

El nombre de máquina puede ser algo descriptivo que facilite su identificación, por ejemplo, <emphasis>Sitio_Nombre</emphasis>. El nombre de máquina tiene que ser el nombre NetBIOS del cliente para unirse al dominio. El "$" tiene que añadirse al nombre NetBIOS o Samba no los reconocerá como cuenta de máquina de confianza.
        </para>
        <para>
Ahora que se ha creado la cuenta Unix correspondiente, el siguiente paso es crear la cuenta samba para el cliente que contiene la contraseña inicial ce cuenta de confianza. Esto se puede hacer con lar orden <command>smbpasswd</command> de la siguiente forma:
        </para>
        <screen>
<literal>root# </literal><emphasis role="bold"><literal>smbpasswd -a -m machine_name</literal></emphasis>
        </screen>
        <para>
        </para>
        <para>

donde  <emphasis><literal>machine_name</literal></emphasis> es el nombre NetBIOS de la máquina. El RID de la nueva cuenta de máquina se genera a partir del UID de la correspondiente cuenta Unix.
        </para>
        <para>
        </para>

      </section>
      <section remap="h3">
        <title>Unir el cliente al dominio immediatamente</title>
        <para>
La creción manual de la cuenta de confianza de máquina usando este método es equivalente a crear una cuenta de confianza de máquina en un PDC NT <anchor id="dbdoclet.id.id2898910"/> usando <emphasis>Server Management Tools</emphasis>. Desde el instante de la creación de la cuenta y el instante en que el cliente se une al dominio y cambia la contraseña, el sistema es vulnerable a que un intruso se una al dominio utilizando una máquina con el mismo nombre NetBIOS. Un PDC, por definición, confía en los miembros del dominio y puede proporcionar un buen conjunto de información sobre a esos clientes.

        </para>
        <para>
        </para>

      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2898934"/>Gestionar cuentas de confianza de máquinas usando la gestión de NT4</title>
        <para>
 
Para crear automáticamente cuentas de confianza de máquinas es básico un <anchor id="dbdoclet.id.id2898945"/>script que agregue la máquina. Esto se aplica, no importa si uno usa la creación de cuenta automática o la gestión de Servidor de Dominio NT4.
        </para>
        <para>
          <anchor id="dbdoclet.id.id2898963"/>
Si la máquina desde la cual está intentando gestionar el dominio es un estación MSW NT4 o 200x/XP Professional, la herramienta que tiene que escoger es  <emphasis role="bold">SRVTOOLS.EXE</emphasis>. Cuando se ejecuta, en el directorio destino, descomprimirá <emphasis role="bold">SrvMgr.exe</emphasis> y <emphasis role="bold">UsrMgr.exe</emphasis> (ambas son herramientas de gestión del dominio para estaciones MSW NT4).  

        </para>
        <para>
          <anchor id="dbdoclet.id.id2899009"/>
Si su estación es de la familia 9x/Me, debería descargar el paquete <emphasis role="bold">Nexus.exe</emphasis> de la web de Microsoft. uando se ejecuta, en el directorio destino, descomprimirá las mismas herramientas per o para estas plataformas.

        </para>
        <para>

Mas información  sobe estas herramientas en:
        </para>
        <para>
        </para>
        <informaltable frame="none">
          <tgroup cols="1">
            <colspec colwidth="100*" colname="c1"/>
            <tbody>
              <row>
                <entry><para><ulink url="http://support.microsoft.com/default.aspx?scid=kb;en-us;173673">http://support.microsoft.com/default.aspx?scid=kb;en-us;173673</ulink></para></entry>

              </row>
              <row>
                <entry><para><ulink url="http://support.microsoft.com/default.aspx?scid=kb;en-us;172540">http://support.microsoft.com/default.aspx?scid=kb;en-us;172540</ulink></para></entry>

              </row>

            </tbody>

          </tgroup>

        </informaltable>
        <para>
        </para>
        <para>

Lance <emphasis role="bold">srvmgr.exe</emphasis> (Server Manager for Domains) y siga estos pasos: 
        </para>
        <para>
 <emphasis role="bold">Gestión de cuentas de confianza de máquina del servidor</emphasis>
        </para>
        <orderedlist>
          <listitem>
            <para>
 
 Del menú seleccione Máquina
            </para>

          </listitem>
          <listitem>
            <para>
 
 Seleccione el dominio
            </para>

          </listitem>
          <listitem>
            <para>
 
 Seleccione el nombre del dominio que quiere a admistrar en el panel Seleccionar Dominio y pulse Aceptar. 
            </para>

          </listitem>
          <listitem>
            <para>
 
 De nuevo, seleccione Máquina.
            </para>

          </listitem>
          <listitem>
            <para>
 
 Seleccione Agregar a Dominio
            </para>

          </listitem>
          <listitem>
            <para>
 
  En el cuado de diálogo, haga clic en el botón Añadir Estación NT del servidir, entonces introduzca el nombre de maquina en el campo correspondiente u pulse el botón Agregar.
            </para>

          </listitem>
</orderedlist>
        <para>
        </para>

      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2899200"/>Creación al vuelo de cuentas de máquina de confianza</title>
        <para>
 El segundo método, y recomendado, de creación decuentas de confianza de máquinas es simplmente permitir que el servidor samba las cree cuando lo necesite cuando el cliente se une al dominio. 

        </para>
        <para>
Como cada cuenta de confianza de máquina de samba necesita una cuenta Unix asociada es necesario proporcionar un método para crearla; para esto es necesario configurar el parámetro de samba add machine script en smb.conf. Sin embar go las cuentas Unix correspondiente también se pueden crear a mano.
        </para>
        <para>

Por ejemplo(RedHat)
        </para>
        <informaltable frame="none">
          <tgroup cols="1">
            <colspec colwidth="100*" colname="c1"/>
            <tbody>
              <row>
                <entry><para></para></entry>

              </row>
              <row>
                <entry><para><emphasis><literal>[global]</literal></emphasis></para></entry>

              </row>
              <row>
                <entry><para># &lt;...remainder of parameters...&gt;</para></entry>

              </row>
              <row>
                <entry><para><emphasis><literal>
 
 add machine script = /usr/sbin/useradd -d /dev/null -g 100 \</literal></emphasis></para></entry>

              </row>
              <row>
                <entry><para><emphasis><literal> -s /bin/false -M %u</literal></emphasis></para></entry>

              </row>

            </tbody>

          </tgroup>

        </informaltable>
        <para>
        </para>

      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2899293"/>Hacer miembros del dominio a estaciones o servidores MSW</title>
        <para>
 El procedicmiento para integrar estaciones o servidores  MSW como miembros el dominio varía con la versión.

        </para>
        <para>
        </para>
        <section remap="h4">
          <title><anchor id="dbdoclet.id.id2899306"/>Clientes Windows 200x/XP Professional</title>
          <para>
 Cuando el usuario quiere hacer cliente un miembreo del dominio, W2000 solicita una cuenta y una contraseña que tengan privilegios par crear cuentas de máquina en el dominio. Se tiene que introducir una cuenta de administrador de Samba (una cuenta Samba con privilegios en el servidor); la operación falla si se introduce una cuenta de usuario ordinario.
 
          </para>
          <para>
Por motivos de seguridad, la cuenta de administrador debería tener una contraseña distinta a la de root en /etc/passwd.
 
          </para>
          <para>
El nombre de la cuenta que se usa para crear cuentas de máquinas miembro, puede ser cualquiera. Si es distinta a root, fácilmente se puede asociar a la de <literal>root</literal> en el fichero indicado por el parámetro, por ejemplo  <anchor id="dbdoclet.id.id2899364"/>username map = /etc/samba/smbusers.

          </para>
          <para>
La clave de sesión de la cuenta de  administrador Samba actúa como clave de cifrado para definir la contraseña de la cuenta de confianza de máquina. La cuenta de confianza de máquina se creará automáticamente o se acutaliza si existe.
 
          </para>
          <para>
          </para>
</section>
        <section remap="h4">
          <title><anchor id="dbdoclet.id.id2899383"/>Clientes Windows NT4</title>
          <para>
 Si la cuenta de máquina se ha creado manualmente, introduzca el nombre de dominio en el menú de cambio de identificación, pero no marque en crear cuenta de máquina en el dominio. En este caso se usa la cuenta de confianza de máquina para unir la máquina al dominio.
          </para>
          <para>

Si la cuenta de confianza de máquina se crea automáticamente, introduzca el nombre de dominio en el menú de cambio de identificación, y marque en crear cuenta de máquina en el dominio. En este caso, la unión al dominio  actúa como en el caso de W2000, es dedir, se pide una cuenta de administrador de Samba.
          </para>
          <para>
          </para>
</section>
        <section remap="h4">
          <title><anchor id="dbdoclet.id.id2899425"/>Cliente Samba</title>
          <para>
 La unión de un cliente samba está documentada en <ulink url="domain-member.html#domain-member-server">Servidores Miembros de un dominio</ulink>. 
          </para>
          <para>
          </para>
</section>

      </section>

    </section>
    <section remap="h2">
      <title><anchor id="dbdoclet.id.domain_member_server"/>Servidores Miembros de un dominio</title>
      <para>
 Este modo de operación del servidor implica que la máquina Samba sea miembro del contexto de seguridad de un dominio. Eso, por definición, significa que todas las validaciones se realizarán de foram centralizada. El mecanismo de validación puede ser estilo NT3/4 o puede ser mediante un servidor Active Directory bajo MSW 2000 o posterior.
      </para>
      <para>
Por supuesto, debe quedar claro que el mecanismo último de validación podría ser cualquier arquitectura de servidor de directorios admitida por samba. Puede ser LDAP (de OpenLDAP), iPlanet de Sun, o NetWare Directory Server, u otros.
      </para>
      <section remap="h3">
        <title>Observación</title>
        <para>
Cuando samba se configura para utilizar LDAP, u otro servicio de gestión de identidad o de directorio hace que samba continúe realizando validaciones de usuarios y máquinas. Se debe observar qie el servidor LDAP no realiza la validación en lugar de lo que samba estádiseñado para hacer.
        </para>
        <para>
 Consulte Control del Dominio para más información sobre como crear cuentas de maquina  para servidores miembros del dominio y también información sobre como activar la máquina samba miembro del dominio  para unirse al dominio y que sea completamente confiable.       
	</para>

      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2899515"/>Unir un dominio tipo NT4 con Samba-3</title>
        <para>
 <ulink url="domain-member.html#assumptions">La siguiente tabla</ulink>  muestra las lista de nombres que se van a utilizar en el resto del capítulo.
        </para>
        <para>
          <anchor id="dbdoclet.id.assumptions"/> <emphasis role="bold">Tabla 7.1. Suposiciones</emphasis>
        </para>
        <informaltable frame="all">
          <tgroup cols="2">
            <colspec colwidth="50*" colname="c1"/>
            <colspec colwidth="50*" colname="c2"/>
            <tbody>
              <row>
                <entry align="right" valign="middle"><para>Nombre NetBIOS:</para></entry>
                <entry align="left" valign="middle"><para>SERV1</para></entry>

              </row>
              <row>
                <entry align="right" valign="middle"><para>nombre de dominio Windows 200x/NT:</para></entry>
                <entry align="left" valign="middle"><para>MIDEARTH</para></entry>

              </row>
              <row>
                <entry align="right" valign="middle"><para>Nombre Netbios del PDC:</para></entry>
                <entry align="left" valign="middle"><para>DOMPDC</para></entry>

              </row>
              <row>
                <entry align="right" valign="middle"><para>Nombres Netbios del BDC:</para></entry>
                <entry align="left" valign="middle"><para>DOMBDC1 and DOMBDC2</para></entry>

              </row>

            </tbody>

          </tgroup>

        </informaltable>
        <para>

Primero tiene que editar el fichero smb.conf para indicar a Samba que utilice la seguridad del dominio.
        </para>
        <para>

 Cambie (o añada) el parámetro <anchor id="dbdoclet.id.id2899633"/>security en la sección [global] de smb.conf para que aparezca:
        </para>
        <para>
        </para>
        <informaltable frame="none">
          <tgroup cols="1">
            <colspec colwidth="100*" colname="c1"/>
            <tbody>
              <row>
                <entry><para><emphasis><literal>
 
 security = domain</literal></emphasis></para></entry>

              </row>

            </tbody>

          </tgroup>

        </informaltable>
        <para>
        </para>
        <para>
A continuación modifique el paráemtro <anchor id="dbdoclet.id.id2899683"/>workgroup de la sección [global] y ponga:
        </para>
        <para>
        </para>
        <informaltable frame="none">
          <tgroup cols="1">
            <colspec colwidth="100*" colname="c1"/>
            <tbody>
              <row>
                <entry><para><emphasis><literal>
 
 workgroup = MIDEARTH</literal></emphasis></para></entry>

              </row>

            </tbody>

          </tgroup>

        </informaltable>
        <para>

Este es el nombre del dominio al que nos estamos uniendo.
        </para>
        <para>
También tiene que tener el parámetro <anchor id="dbdoclet.id.id2899737"/>encrypt passwords puesto a "yes" para que sus usuarios se  validen en el PDC NT. Este es el valor predeterminado del parámetro si no se especifica. No hay necesidad de especificar este parámetro, pero si se especifica tiene que tener el valor <literal>Yes</literal>. 
        </para>
        <para>

Finalmente, añada o modifique el parámetro <anchor id="dbdoclet.id.id2899770"/>password server:
        </para>
        <para>
        </para>
        <informaltable frame="none">
          <tgroup cols="1">
            <colspec colwidth="100*" colname="c1"/>
            <tbody>
              <row>
                <entry><para><emphasis><literal>
 
 password server = DOMPDC DOMBDC1 DOMBDC2</literal></emphasis></para></entry>

              </row>

            </tbody>

          </tgroup>

        </informaltable>
        <para>
        </para>
        <para>
Estos son los controladores primario y secundarios que samba intentará contactar para validar usuarios. Samba intentará contactar en orden, por lo que puede ser intersante reordenar la lista para agilizar la validación entre los distintos controladores de dominio.

        </para>
        <para>
De forma alternativa si quiere que smbd determine automáticamente la lista de controladores de dominio puede poner la línea como:
        </para>
        <para>
        </para>
        <informaltable frame="none">
          <tgroup cols="1">
            <colspec colwidth="100*" colname="c1"/>
            <tbody>
              <row>
                <entry><para><emphasis><literal>
 
 password server = *</literal></emphasis></para></entry>

              </row>

            </tbody>

          </tgroup>

        </informaltable>
        <para>
        </para>
        <para>
Este método permite a Samba usar exactamente el mismo mecanismo que NT. Este método utiliza una resolución basada en broadcast, una búsqueda WINS o utiliza DNS para localizar el controlador de dominio.
 
        </para>
        <para>
Para unirse al dominio, ejecute:
        </para>
        <para>
        </para>
        <screen>
<literal>root# </literal><emphasis role="bold"><literal>net join -S DOMPDC -UAdministrator%password</literal></emphasis>
        </screen>
        <para>
        </para>
        <para>

Si no se incluye el argumento <literal>-S DOMPDC</literal>, el nombre de dominio se obtiene de <literal>smb.conf</literal>. 
        </para>
        <para>
La máquina se une al dominio DOM y el PDC del dominio (la única máquina que tiene acceso de escritura en la base de datos SAM del dominio) es DOMPDC, por consiguiente use la opción -S. También <emphasis><literal>Administrator%password</literal></emphasis> son el nombre y la contraseña de la cuenta que dispone de los privilegios necesarios para agregar máquinas al dominio. Si todo es correcto, aparecerá un mensaje con el texto que viene a continuación.
        </para>
	<para>
	Para el caso de dominios estilo NT4
	</para>
        <screen>
<literal>Joined domain DOM.</literal>
        </screen>
        <para>
        </para>
        <para>

Si se usa Active directory::
        </para>
        <screen>
<literal>Joined SERV1 to realm MYREALM.</literal>
        </screen>
        <para>
        </para>
        <para>
En la página de manual de  <emphasis role="bold">net</emphasis> podemos encontrar más información.
 
        </para>
        <para>

Este proceso une el servidor al dominio sin tener que crear la cuenta de confianza de máquina en el PDC previamente a mano. 
        </para>
        <para>

Esta orden se ejecuta a través del protocolo de cambio de contraseña de cuenta de máquina, escribe la nuena contraseña (aleatoria) de máquina para este servidor Saamba en un fichero en el mismo directorio donde se deberia guardar normalmente el fichero smbpasswd:
        </para>
        <screen>
<literal>/usr/local/samba/private/secrets.tdb</literal>
o
<literal>/etc/samba/secrets.tdb</literal>.
        </screen>
        <para>
        </para>
        <para>
Este fichero lo crea root y es de su propiedad y ningún otro usuario lo puede leer. Esta es la clave para la seguridad a nivel de dominio se su sisteama y debería protegerse de la misma forma que el fichero de "shadow password".
 
        </para>
        <para>
Por último, reinicie los demonios Samba y está listo para que los clientes empiecen a usar la seguridad del dominio. La forma e reiniciar samba dependerá de la distribución, per en la mayoría de los casos sería suficiente con:
 
        </para>
        <screen>
<literal>root# </literal>/etc/init.d/samba restart
        </screen>
	<para>
o
	</para>
	<screen>
<literal>root# </literal>/etc/init.d/samba restart
	</screen>
        <para>
        </para>


      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2900048"/>Por qué esto es mejor que <emphasis><literal>security = server</literal></emphasis></title>
        <para>
 Actualmente la seguridad del dominio en Samba no leevita tener que crear los usuarios locales UNIX para representar a los usuarios enlazados al servidor. Esto significa que si  
el usuario del dominio <literal>DOM\fred</literal> se enlaza a su servidor de seguridad de dominio samba, tiene que haber una cuenta Unix local llamada fred para representar a ese usuario en el sistema de ficheros Unix. Esto es parecido al antiguo sistema de seguridad  <anchor id="dbdoclet.id.id2900077"/>security = server, donde Samba pasaría la solicitud de validación a Un servidor WNT de la misma forma que lo harían unos W95 o W98. 

        </para>
        <para>
Mire <ulink url="winbind.html">Winbind</ulink>, el capítulo de "Uso de cuentas de dominio" para tener más detalles sobre un sistema que asigne automáticamente  UID y GID Unix a los usuarios  y grupos del WNT.
 
        </para>
        <para>
La ventaja de la seguridad a nivel de dominio es que la validación pasa por el canal de validaciín RPC de la misma forma que lo haría un servidor WNT. Esto quiere decir que los servidores Samba participan en las relaciones de confianza del dominio de la misma forma que lo hacen los servidores WNT, es decir, puede agregar servidores Samba a los recursos de un dominio y tener la validación del recurso del PDC del dominio a una cuenta PDC del dominio. 

        </para>
        <para>
Además, con <anchor id="dbdoclet.id.id2900120"/>security = server, cada demonio samba del servidor tiene que mantener una conexión abierta para validar. Esto puede restar recursos de conexión a un WNT ya agotar la conexiones disponibles. Sin embargo, con <anchor id="dbdoclet.id.id2900133"/>security = domain los demonios Samba conectan con el PDC/BDC sólo mientras es necesario para validar al usuario y cierran la conexión, conservando así recursos de conexión el PDC.
 
        </para>
        <para>
Y para terminar, actuando del la misma manera que un servidor WNT validándose en un PDC significa que como parte de la espuesta de validación, el servidor Samba obtiene la informacón de identificación del usuario como el SID, la lista de grupos NT a los que pertenece, etc. 

        </para>
        <para>
        </para>

      </section>
      <section remap="h3">
        <title>Note</title>
        <para>

La mayor parte del texto de este documento se publicó como un artículo en "Web magazine LinuxWorld",<ulink url="http://www.linuxworld.com">LinuxWorld</ulink> como el artículo <ulink url="http://www.linuxworld.com/linuxworld/lw-1998-10/lw-10-samba.html">http://www.linuxworld.com/linuxworld/lw-1998-10/lw-10-samba.html</ulink><emphasis>Doing the NIS/NT Samba</emphasis>. 
        </para>
        <para>
Después aparece con la documentacón incluida con la distribución de samba.
        </para>

      </section>

    </section>
    <section remap="h2">
      <title><anchor id="dbdoclet.id.ads_member"/>Pertenencia de Samba a un dominio ADS</title>
      <para>
 <anchor id="dbdoclet.id.id2900201"/><anchor id="dbdoclet.id.id2900210"/><anchor id="dbdoclet.id.id2900221"/><anchor id="dbdoclet.id.id2900229"/>
Esto una guía, a grandes resgos,  sobre como configurar la validación Samba-3 con Kerberos en un KDC  W200X. Se supone al lector famimliarizado con Kerberos.
      </para>
      <para>
      </para>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2900240"/>Configurar <literal>smb.conf</literal></title>
        <para>
 
Al menos debe tener las siguientes opciones en smb.conf: <literal>smb.conf</literal>: 
        </para>
        <informaltable frame="none">
          <tgroup cols="1">
            <colspec colwidth="100*" colname="c1"/>
            <tbody>
              <row>
                <entry><para><emphasis><literal>
 
 realm = your.kerberos.REALM</literal></emphasis></para></entry>

              </row>
              <row>
                <entry><para><emphasis><literal>
 
 security = ADS</literal></emphasis></para></entry>

              </row>
              <row>
                <entry><para># The following parameter need only be specified if present.</para></entry>

              </row>
              <row>
                <entry><para># The default setting is not present is Yes.</para></entry>

              </row>
              <row>
                <entry><para><emphasis><literal>
 
 encrypt passwords = yes</literal></emphasis></para></entry>

              </row>

            </tbody>

          </tgroup>

        </informaltable>
        <para>
En caso de que samba no pueda identificar correctamente el servidor ADS adecuado usando el nobre de ámbito (realm), utilice la opción <anchor id="dbdoclet.id.id2900350"/>password server en smb.conf:
 
        </para>
        <informaltable frame="none">
          <tgroup cols="1">
            <colspec colwidth="100*" colname="c1"/>
            <tbody>
              <row>
                <entry><para><emphasis><literal>
 
 password server = your.kerberos.server</literal></emphasis></para></entry>

              </row>

            </tbody>

          </tgroup>

        </informaltable>
        <para>
        </para>
        <para>
        </para>

      </section>
      <section remap="h3">
        <title>Observaciones</title>
        <para>
No es necesario un fichero smbpasswd, y los clientes más antiguos se validarán como si estuviera  <anchor id="dbdoclet.id.id2900403"/>security = domain, aunque no hará ningún daño y permitirá tener usuarios locales que no están en el dominio.
 
        </para>
        <para>
        </para>

      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2900416"/>Configurar <literal>/etc/krb5.conf</literal></title>
        <para>
 <anchor id="dbdoclet.id.id2900433"/><anchor id="dbdoclet.id.id2900441"/>
Con Kerberos de MIT y Heimdal no es necesario configurar <literal>/etc/krb5.conf</literal>.
        </para>
        <para>
Los servidores MS ADS crean automáticamente registros SRV en la zona <emphasis><literal>_kerberos.REALM.NAME</literal></emphasis> DNS para cada KDC del ámbito (realm)
Microsoft Active Directory servers automatically create SRV records in the DNS zone <emphasis><literal>_kerberos.REALM.NAME</literal></emphasis> for each KDC in the realm. Esto es parte del proceso de instalación y configuración usado para crear un dominio Active Directory. 
        </para>
        <para>
Tanto las biblitoecas KRB5  MIT como Heimdal verifican los registros SRV, por tento encontrarán automáticamente el KDC. Además,  <literal>krb5.conf</literal> sólo permite especificar un solo  KDC incluso si hay más de uno. Mediante las búsquedas DNS podremosusar cualquier KDC disponible:
 
        </para>
        <para>

Cuando se configura <literal>krb5.conf</literal>, la configuración mínima es:
        </para>
        <screen>
[libdefaults]
	default_realm = YOUR.KERBEROS.REALM

[realms]
	YOUR.KERBEROS.REALM = {
	kdc = your.kerberos.server
	}

[domain_realms]
	.kerberos.server = YOUR.KERBEROS.REALM
        </screen>
        <para>

Si usa versiones de Heimdal previas a 0.6 use la siguiente configuración:
        </para>
        <screen>
[libdefaults]
	default_realm      = YOUR.KERBEROS.REALM
	default_etypes     = des-cbc-crc des-cbc-md5
	default_etypes_des = des-cbc-crc des-cbc-md5

[realms]
        YOUR.KERBEROS.REALM = {
        kdc = your.kerberos.server
	}

[domain_realms]
        .kerberos.server = YOUR.KERBEROS.REALM
        </screen>
        <para>
        </para>
        <para>
          <anchor id="dbdoclet.id.id2900539"/>
Verifique su configuración ejecutando <emphasis role="bold"><literal>kinit USERNAME@REALM</literal></emphasis> y asegurándose que su contraseña la acepta el  KDC W2000.
        </para>
        <para>

Con las versiones Heimdal anteriores a 0.6.x sólo puede usar cuentas nuevas creadas en ADS o cuentas con la contraseña modificada tras la instalación. Por el momento, el KDC de W2003 sólo se puede usar con versiones de Heimdal posteriores a 0.6. Por desgracia toda el área está en modificación.
        </para>
        <para>
        </para>

      </section>
      <section remap="h3">
        <title>Observaciones</title>
        <para>
El realm tiene que ir en mayúsculas o aparecera el mensaje de error kerberos <emphasis>Cannot find KDC for requested realm while getting initial credentials</emphasis>. Kerberos distingue entre mayúsculas y minúsculas.

        </para>
        <para>
        </para>

      </section>
      <section remap="h3">
        <title>Observaciones</title>
        <para>
La hora  entre servidores tiene que estar sincronizada. Obtendrá kinit(v5): "Clock skew too great while getting initial credentials" si la diferencia es mayor a cinco minutos.
        </para>
        <para>
Las desviaciones del reloj se pueden configurar en le protocolo kerberos; el valor predeterminado es cinco minutos.

        </para>
        <para>
La forma más fácil de asegurarse de que esto va a funcionar es añadir una línea en  /etc/hosts asociando la dirección IP del KDC con el nombre NetBIOS. Si no hace esto correctamente aparecerá un error cuando trate de unir el realm.
        </para>
        <para>

The easiest way to ensure you get this right is to add a <literal>/etc/hosts</literal> entry mapping the IP address of your KDC to 
its NetBIOS name. If you do not get this correct then you will get a local error when you try to join the realm. 
        </para>
        <para>
Si sólo quiere soporte Kerberos en smbclient entonces puede ir directamente a la <ulink url="domain-member.html#ads-test-smbclient">verificaciones smbclient</ulink> ahora. La <ulink url="domain-member.html#ads-create-machine-account">creación la cuenta de máquina</ulink> y las <ulink url="domain-member.html#ads-test-server">verificaciones de la configuración del servidor</ulink> sólo son necesarias si quiere soporte Kerberos para smbd y winbindd.

        </para>

      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.ads_create_machine_account"/>Crear la cuenta de máquina</title>
        <para>
 Ejecute lo siguiente con un usuario, normalmente root, que tenga permisos en el directorio privado (private) de samba:

        </para>
        <screen>
<literal>root# </literal> 
<emphasis role="bold"><literal>net ads join -U Administrator%password</literal></emphasis>
        </screen>
        <para>
        </para>
        <para>
Cuando cree un cliente Windows miembro de un dominio ADS con una organización compleja, le puede interesar la cuenta de máquina en una unidad organizativa especial. Samba-3 lo permite utilizando la siguiente sintaxis:
        </para>
        <screen>
<literal>root# </literal> 
<emphasis role="bold"><literal>kinit Administrator@your.kerberos.REALM</literal></emphasis>
<literal>root# </literal> 
<emphasis role="bold"><literal>net ads join "organizational_unit&amp;"</literal></emphasis>
        </screen>
        <para>
Por ejemplo, puede querer crear una cunta de máquina en un contenedor llamado <emphasis>Servers</emphasis> bajo el directorio organizativo <emphasis>Computers\BusinessUnit\Department</emphasis> de esta forma:

        </para>
        <screen>
<literal>root# </literal> 
<emphasis role="bold"><literal>net ads join "Computers\BusinessUnit\Department\Servers"</literal></emphasis>
        </screen>
        <para>
        </para>
        <para>
        </para>
        <section remap="h4">
          <title><anchor id="dbdoclet.id.id2900838"/>Posibles Errores</title>
          <para>
 
          </para>
          <para>
            <variablelist>
              <varlistentry>
                <term>Soporte ADS no compilado</term>
                <listitem>
                  <para>
 Hay que reconfigurar Samba (borrar config.cache) y recompilar (make clean all install) una vez que las bibliotecas y ficheros de cabecera Kerberos estén instalados.
                  </para>

                </listitem>

              </varlistentry>
              <varlistentry>
                <term>net ads join solicita nombre de usuario</term>
                <listitem>
                  <para>
 Tiene que identifiarse en le dominio usando <emphasis role="bold"><literal>kinit USERNAME@REALM</literal></emphasis>. <emphasis><literal>USERNAME</literal></emphasis> tiene que ser un usuario que tenga permisos para añadir una máquinaal dominio.
                  </para>

                </listitem>

              </varlistentry>
              <varlistentry>
                <term>Tipos de encriptación/checksum no admitidos</term>
                <listitem>
                  <para>
 Asegúrese de que <literal>/etc/krb5.conf</literal> está configurado corerctamente para los tipo y versión de kerberos instalado en el sistema. 
                  </para>

                </listitem>

              </varlistentry>

            </variablelist>
 
          </para>
          <para>
          </para>
</section>

      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.ads_test_server"/>Comprobando la configuración del sevidor</title>
        <para>
Si la unión al dominio ha sido correcta verá unanueva cuenta de máquina con el nombre NetBIOS del servidor Samba en Active Directory (en la carpeta Máquinas bajo Usuarios y máquinas).
        </para>
        <para>
En un cliente W2000, intente <emphasis role="bold"><literal>net use * \\server\share</literal></emphasis>. Debería conectarse con with Kerberos sin necesidad de contraseña. Si falla ejecute <emphasis role="bold"><literal>klist tickets</literal></emphasis>. ¿Ha obtenido un ticket para el servidor? ¿Tiene cifrado DES-CBC-MD5?
        </para>

      <section remap="h4">
        <title>Observaciones</title>
        <para>

Samba puede usar cifrado DES-CBC-MD5 y codificación ARCFOUR-HMAC-MD5.
        </para>

      </section>
      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.ads_test_smbclient"/>Comprobación con smbclient</title>
        <para>
 <anchor id="dbdoclet.id.id2901001"/>
Intente iniciar una sesión desde su servidor samba en un servidor W2000 o su servidor samba usando smbclient y Kerberos. Use smbclient de la forma habitual, pero especifique la opción <literal>-k</literal> para elegir la validación Kerberos.

        </para>
        <para>
        </para>


      <section remap="h4">
        <title><anchor id="dbdoclet.id.id2901031"/>Observaciones</title>
        <para>
 Tiene que cambiar la contrasela del administrador al menos una vez tras la instalación del controlador de dominio para crear los tipos de cifrado correctos. 
        </para>
        <para>
W2000 parece no crear las configuraciones DNS predeterminadas _kerberos._udp y _ldap._tcp. Quizás esto se corrija en 
próximos service packs. 
        </para>
        <para>
        </para>
      </section>
      </section>

    </section>
    <section remap="h2">
      <title><anchor id="dbdoclet.id.id2901066"/>Compartir asociaciones de ID de usuarios entre miembrso Samba del dominio</title>
      <para>
Samba asocia usuarios UNIX y grupos (identificados por UID y GID) con usuarios y grupos Windows (identificados por SID). Estas asociacione la realiza el subsistema <emphasis><literal>idmap</literal></emphasis> de Samba. 

      </para>
      <para>
En algunos casos es útil compartir estas asociaciones entre miembros Samba del dominio, así la asociación nombre->id es idéntica en todas la máquinas. Esto puede ser necesario en paarticular cuando comparte ficheros a travñes de CIFS y NFS.
 
      </para>
      <para>
Para usar <emphasis><literal>ldap idmap suffix</literal></emphasis> de <emphasis>LDAP</emphasis> ponga:
      </para>
      <informaltable frame="none">
        <tgroup cols="1">
          <colspec colwidth="100*" colname="c1"/>
          <tbody>
            <row>
              <entry><para><emphasis><literal>
 
 ldap idmap suffix = ou=Idmap,dc=quenya,dc=org
 		</literal></emphasis></para></entry>

            </row>

          </tbody>

        </tgroup>

      </informaltable>
      <para>
Vea la página de manual de smb.conf y consulte el parámetro <anchor id="dbdoclet.id.id2901152"/>"ldap idmap suffix para más detalles.
      </para>
      <para>
No olvide especificar también <anchor id="dbdoclet.id.id2901166"/>ldap admin dn y asegúrese de que la contraseña administrativa de ldap está en <literal>secrets.tdb</literal> usando:

      </para>
      <screen>
<literal>root# </literal> smbpasswd -w ldap-admin-password
      </screen>
      <para>
      </para>

    </section>
    <section remap="h2">
      <title><anchor id="dbdoclet.id.id2901198"/>Errores frecuentes</title>
      <para>
En el proceso de añadir/borrar/volver a añadir cuentas de máquina del dominio hay muchas trampas en las que se puede caer y pequeñas cosas que peden ser erróneas. Es particularmente interesante con qué frecuencia los suscriptores de las lista de Samba han llegado a la conclusión, tras repetidos intentos de añadir una cuenta de máquina que es necesaria, de que es necesario reinstalar MSW en la máquina. En realidad es raramente necesario reinstalar a causa de ste tipo de problemas. La solución real es con frecuencia bastante simple y si no se entienden bien las funciones de red de MSW el probable que esto suceda.
      </para>
      <para>
      </para>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2901231"/>No puedo volver a añadir la máquina al dominio</title>
        <para>
Se ha reinstalado unaestación de trabajo del dominio. La cuenta de máquina del dominio original se eliminó y se agregó inmediatamente. La estación de trabajo no se une al dominio si se usa el mismo nombre de máquina. Los intentos de añadir la máquina fallan si uso el mismo nombre de máquina con un mensaje que indica que la máquina ya existe en la red.
        </para>
        <para>
Esto se debe a que el nombre original aun está en la cache de nombres NetBIOS y tiene que expirar tras el borrado de la cuenta antes de poder añadir el nuevo nombre como miembreo del dominio. Lo mejor es borrar la anterior cuenta y añador la máquina con un nuevo nombre.
        </para>
        <para>
        </para>

      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2901267"/>Fallo al añadir máquina al dominio</title>
        <para>
El fallo al agregar máquinas  W200x/XP Professional al PDC Samba del dominio produce un mensaje similar la 'La máquina no se pudo agrgar al dominio en este momento, hay un problema de red, inténtelo más tarde'.
        </para>
        <para>
Debería comprobar que hay un parámetro add machine script en el fichero smb.conf. Si no existe, incorpórelo de forma apropiada para su sistema. Si se ha definido un script, tendrá que depurar su ejecución. Incremente log level en the smb.conf a nivel 10, entonces intente de nuevo la operación. Observe los logs para ver que operación está fallando.
        </para>
        <para>

Las posibles causas incluyen:
        </para>
        <para>
          <itemizedlist>
            <listitem>
              <para>
 
 * El script no existe o puede que no esté en la ruta especificada. 
              </para>
              <para>
                <emphasis>Corrección:</emphasis> Asegúrese de ejecutarlo manualmente y que crea las cuentas unix y SAM de Samba.
              </para>

            </listitem>
            <listitem>
              <para>
 * La máquina no se puede añadir al fichero /etc/passwd de cuentas del sistema UNIX.

              </para>
              <para>
                <emphasis>Corrección:</emphasis> Verifique que eñl nombre de máquina es un nombre UNIX legal. Si se llama a  useradd asegúrese que el nombre de máquina se puede añadir con esta herramienta.  Useradd, en algunos sistemas no permiten ni mayúsculas ni espacios. 

              </para>

            </listitem>
</itemizedlist>
 
<anchor id="dbdoclet.id.id2901403"/>add machine script add machine script no crea la cuenta de máquina en la base de datos de usuarios Samba, sólo crea el cuenta UNIX con la que asociar la cuenta samba. 

        </para>

      </section>
      <section remap="h3">
        <title><anchor id="dbdoclet.id.id2901417"/>No puedo unir samba a un PDC W2003</title>
        <para>
 W2003 necesita una firma SMB. El cliente de firma SMB se ha introducido en Samba-3.0. Ponga <anchor id="dbdoclet.id.id2901430"/>pnego = yes cuando se comunique con un servidor W2003.

        </para>


      </section>

    </section>

  </section>
